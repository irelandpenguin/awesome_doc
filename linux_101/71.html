<HEAD><TITLE>鸟哥的 Linux 私房菜 -- 代理服务器 squid 设定</TITLE>
<META http-equiv=Content-Type content="text/html; charset=gb2312">
<META content=VBird name=Author>
<META content="Mozilla/4.5 [zh-TW] (WinNT; I) [Netscape]" name=GENERATOR>
<STYLE>
  <!--
  body{background-image=url("71_files/VBirdLinux[1].jpg");background-ATTACHMENT=FIXED}
   -->
</STYLE>
</head>
<BODY style="CURSOR: auto" background="71_files/VBirdLinux[14].jpg" nosave="">
<CENTER>
<CENTER><B><FONT color=#3333ff size=+2><FONT face=SimSun>鸟哥的</FONT><FONT face="Times New Roman,Times"> Linux </FONT><FONT face=SimSun>与</FONT><FONT face="Times New Roman,Times"> ADSL </FONT><FONT face=SimSun>私房菜</FONT></FONT></B> <BR><A href="http://linux.vbird.org/" target=_top><IMG height=25 src="61_files/VBirdTitle2[10].jpg" width=90 border=0 nosave=""></A> <A href="http://linux.vbird.org/linux_basic"><IMG height=25 src="39_files/icon_system[3].gif" width=90 border=0 nosave=""></A> <A href="http://linux.vbird.org/linux_server"><IMG height=25 src="55_files/icon_server[13].gif" width=90 border=0 nosave=""></A> <A href="http://linux.vbird.org/linux_security"><IMG height=25 src="71_files/icon_security[10].jpg" width=90 border=0 nosave=""></A> <A href="http://phorum.vbird.org/" target=_blank><IMG height=25 src="60_files/icon_forums[10].gif" width=90 border=0 nosave=""></A> <A href="http://linux.vbird.org/adsl"><IMG height=25 src="50_files/icon_adsl[13].gif" width=90 border=0 nosave=""></A> <BR>
<HR width="100%">
</CENTER><FONT color=#3333ff size=+2><A href="http://linux.vbird.org/linux_server/0420squid.php"><FONT face=SimSun>简易</FONT> Proxy Server <FONT face=SimSun>架设</FONT></A></FONT></CENTER>
<DIV align=right><FONT face=SimSun color=#3333ff size=-1>最近更新日期：2003/09/16</FONT></DIV><FONT face=SimSun color=#3333ff size=-2>　</FONT> 
<TABLE cols=1 width="100%" bgColor=#ffcccc border=1>
<TBODY>
<TR>
<TD><FONT color=#000099 size=-1>代理服务器的功能可多的呢！在中大型的企业当中，可以藉由单点对外的 Proxy 主机来达到『节省频宽』的目的，同时，也可以透过这样的 Proxy 架构来达成『高阶防火墙』的设定，这里的『高阶』指的是 OSI 七层协议里面比较高阶段的层级，那就是应用与表现层方面的防火墙啦！那如果对于小型的企业呢？这个 Proxy 也可以达到分流的作用，让不同的目标网站可以透过不同的上层 Proxy 来取得数据！啊！真是很不错的一个服务器啊！不过，这个 Proxy 服务器也是几个常见的服务器里面，硬件要求相对比较高的一个咚咚！因为 Proxy 要求的是『快速』，所以呢，呵呵！当然硬件等级的要求是相当的『蛮像一回事』的！^_^</FONT></TD></TR></TBODY></TABLE><FONT color=#000099 size=-2>　</FONT> <BR><FONT color=#000099 size=+1><A href="#theory">原理</A>：</FONT> <BR><FONT color=#000099>　　：<A href="#theory_whatisproxy">什么是代理服务器</A></FONT> <BR><FONT color=#000099>　　：<A href="#theory_proxysworks">代理服务器的运作方式</A></FONT> <BR><FONT color=#000099>　　：<A href="#theory_things">代理服务器的用途与优缺点</A></FONT> <BR><FONT color=#000099>　　：<A href="#theory_parent_proxy">什么是上层代理服务器？哪里有上层代理服务器</A></FONT> <BR><FONT color=#000099>　　：<A href="#theory_yesorno">我是否一定要设定 Proxy </A>？</FONT> <BR><FONT color=#000099>　　：<A href="#theory_hardware">所需要的硬件要求与最佳硬件配置方式</A></FONT> <BR><FONT color=#000099>　　：<A href="#theory_proxynadnat">代理服务器与 NAT 主机的差异</A></FONT> <BR><FONT color=#000099 size=+1><A href="#package">套件安装</A>：</FONT> <BR><FONT color=#000099>　　：<A href="#package_rpm">使用 RPM 方式安装 squid</A></FONT> <BR><FONT color=#000099>　　：<A href="#package_tarball">使用 Tarball 方式安装 squid</A></FONT> <BR><FONT color=#000099><FONT size=+1><A href="#server">Server 端设定</A></FONT>：</FONT> <BR><FONT color=#000099>　　：<A href="#server_contr">squid 的结构</A></FONT> <BR><FONT color=#000099>　　：<A href="#server_permissions">squid 的 process owner 与 cache directory owner</A></FONT> <BR><FONT color=#000099>　　：<A href="#server_basic">最简易的 squid 设定方法</A></FONT> <BR><FONT color=#000099>　　：<A href="#server_mem_cache">内存与磁盘快取留存百分比设定</A></FONT> <BR><FONT color=#000099>　　：<A href="#server_acl">acl 的用法与用途</A></FONT> <BR><FONT color=#000099>　　：<A href="#server_upper_proxy">上层 Proxy 的选择与负载分流的设定方法</A></FONT> <BR><FONT color=#000099>　　：<A href="#server_time_par">与时间相关的设定值 ( connect_timeout, request_timeout )</A></FONT> <BR><FONT color=#000099>　　：<A href="#server_always_direct">总是系统自己来捉数据(always_direct)</A></FONT> <BR><FONT color=#000099>　　：<A href="#server_access_control">限制使用 proxy 使用者与 proxy 目标的方式 (acl and http_access )</A></FONT> <BR><FONT color=#000099>　　：<A href="#server_other_functions">额外的功能参数</A></FONT> <BR><FONT color=#000099><FONT size=+1><A href="#client">Client 端设定</A></FONT>：</FONT> <BR><FONT color=#000099>　　：<A href="#client_netscape">Netscape</A></FONT> <BR><FONT color=#000099>　　：<A href="#client_ie">Internet Explorer</A></FONT> <BR><FONT color=#000099 size=+1><A href="#serverahead">Server 端进阶设定</A>：</FONT> <BR><FONT color=#000099>　　：<A href="#serverahead_pwebstats">末端资料分析 pwebstat</A></FONT> <BR><FONT color=#000099>　　：<A href="#serverahead_sarg">末端资料分析 sarg</A></FONT> <BR><FONT color=#000099>　　：<A href="#serverahead_firewall">防火墙的规划</A></FONT> <BR><FONT color=#000099>　　：<A href="#serverahead_transparent">NAT 与 Proxy 透过 transparent proxy 设定加快网络传输</A></FONT> <BR><FONT color=#000099>　　：<A href="#serverahead_beca">squid 的注意事项</A></FONT> <BR><FONT color=#000099><A href="#important">重点回顾</A></FONT> <BR><FONT color=#000099><A href="#reference">参考资源</A></FONT> <BR><FONT color=#000099><A href="#FAQ">本章习题练习</A></FONT> <BR>
<HR width="100%">
<A name=theory></A><FONT color=#000099 size=+1>原理：</FONT> 
<UL>代理服务器的原理其实很简单啦！就是以类似代理人的角度去取得使用者所需要的数据就是了！但是由于他的功用，使得我们可以透过代理服务器来额外的达成防火墙的功能！此外，也可以藉由代理服务器 ( Proxy ) 来达成节省频宽的目的，以及加快内部网络的 WWW 存取速度！总之， Proxy 对于大型的企业来说，实在是一个很不错的东西啊！ <BR>　 <BR>
<HR width="100%">
<A name=theory_whatisproxy></A><FONT color=#000099 size=+1>什么是代理服务器</FONT> <BR>　 <BR>在真实世界中，我们或许会帮忙家人去办理一些杂务吧！举个例子来说，例如缴费或者是申办提款卡等等的，那么由于你并不是『申请者本人』而是『代理人』的角色，因此有时候会需要秀出一些证件就是了。那么在网络上面的代理服务器是怎么回事呢？他就是 Proxy Server ！他最主要的功能就如同我们上面提的真实世界一样， <FONT color=#000066>Proxy 会帮 Client 端的用户去向目的地取得客户端所需要的数据</FONT>。所以，当 Client 端指定代理服务器之后，您的所有相关要求( 例如 WWW 的要求 )就会通过代理服务器去捉取！整个代理服务器与客户端的相关性可以由下图约略看出一个端倪： 
<CENTER>　 <BR><IMG height=320 src="71_files/0420squid_proxy1[1].jpg" width=291 nosave=""> <BR><A name=fig_01></A><FONT color=#000066>图一、代理服务器的示意图</FONT> <BR>&nbsp;</CENTER>在内部的计算机都是透过 Proxy 来向 Internet 求取数据的，这就是所谓的『代理服务器』啦！当然，上面的架构仅只是一个案例，还有相当多的非 Intranet 的 Proxy 架构，亦即是你的 PC 与 Proxy 均在 Internet 上面，但是您一样可以透过这个 Proxy 来帮您达到代理人身份的目的呢！ <BR>　 <BR>在 Proxy 与 Client 的相关性当中，您必需要了解的是：<FONT color=#000066>您向外部要求的资料事实上都是 Proxy 帮你取得的</FONT>！怎么说呢？举个例子来说，假如我在我的浏览器 ( 假设是 Netscape 好了 )设定了我们学校的代理服务器主机 proxy.ncku.edu.tw 做为我的 Proxy 好了，再假设我的 IP 是 140.116.44.125 ，那么当我想要取得奇摩网站的新闻信息时，事实上，都是 proxy.ncku.edu.tw 帮我去取得的，所以在奇摩的网站上面看到向他要求资料的人是谁呢？呵呵！当然就是 proxy.ncku.edu.tw 而不是我 140.116.44.125 ！这样可以了解 Proxy 的功能了吗？ <BR>　 <BR>除了这点功能之外， <FONT color=#000066>Proxy 还有一个很棒的额外功能喔，那就是防火墙的功能</FONT>！怎么说呢？看一下上面的图示，您可以发现一件事情，那就是 Client 端的个人计算机要连上 Internet 一定要经过 Proxy 服务器，并且，如果有人想要入侵你的系统时，由于你的 proxy 在最外部啊，所以攻击者就会攻击错方向，如此一来，不就比较安全！此外，由于整个 Intranet 对外都是经过 proxy ，也就是『单点对外』的情况，这种状态底下要来管理防火墙也是比较简单的喔！^_^ <BR>　 <BR>
<HR width="100%">
<A name=theory_proxysworks></A><FONT color=#000099 size=+1>代理服务器的运作方式</FONT> <BR>　 <BR>了解的 Proxy 的功能之后，我们来谈一谈那么 Proxy 到底是怎样运作的呢？为何他会有『加快网络存取效率』的情况？这就必需要以底下的图示来说明了！ <BR>　 
<CENTER><IMG height=232 src="71_files/0420squid_proxy2[1].jpg" width=518 nosave=""> <BR><A name=fig_02></A><FONT color=#000066>图二、代理服务器的运作方式流程图</FONT></CENTER>　 <BR>当 Client 端设定了代理服务器之后，在 Client 端想要取得 Internet 上面的信息时，他是这样取得数据的 (注：那个 Cache 表示为 Proxy 主机的硬盘的意思 )： <BR>　 <BR><B><FONT color=#000066>一、Proxy 有使用者预计要求的数据时( Step 1, 2, 3,4 )：</FONT></B> 
<OL>
<LI><FONT color=#000066>Client 端向 Server 端发送一个数据需求封包；</FONT> 
<LI><FONT color=#000066>Server 端接收之后，先比对这个封包的『来源』与预计要前往的『目标』网站是否为可接受？如果来源与目标都是合法的，或者说，来源与目标网站我们的 Proxy 都能帮忙取得资料时，那么 Server 端会预计开始替 Client 取得资料。这个步骤中比较重要的就是『比对政策』啦，有点像是认证的感觉啦；</FONT> 
<LI><FONT color=#000066>Server 首先会到自己的硬盘里面，也就是所谓的 cache (快取) 查看一下有没有 Client 端所需要的数据，如果有的话，那就将数据直接送到 Client 端 (步骤4) 而不经过向 Internet 要求数据的程序；</FONT> </LI></OL>　 <BR><B><FONT color=#000066>二、Proxy 没有使用者预计要求的数据时 ( Step 1, 2, 3, 5, 6, 2, 3, 7 )：</FONT></B> 
<OL>
<LI><FONT color=#000066>在经过 1, 2, 3 查寻知道 cache 没有数据，或者数据过期之后， Proxy 会向 Internet 上面的目标网站要求数据；</FONT> 
<LI><FONT color=#000066>在将资料取回之后， proxy 会先将取得的数据『储存一份到 cache 当中』；</FONT> 
<LI><FONT color=#000066>最后才将数据传回给 Client 端使用。</FONT> </LI></OL>　 <BR>整个 Proxy 的工作流程就是这个样子，所以，我们就可以知道的是， Proxy 对于 cache 的速度是很要求的，而这个 cache 就是硬盘啦！当然，硬盘容量必需要足够大，而且还要『足够快』才行！因为由上面的流程当中，我们不难发现， Cache 是一直被重复存取的一个地方喔！所以硬盘的好坏就差别很大啦！可以说他是影响一个 Proxy 效能好坏的关键点呢！ <BR>　 <BR>
<HR width="100%">
<A name=theory_things></A><FONT color=#000099 size=+1>代理服务器的用途与优缺点</FONT> <BR>　 <BR>一般来说，代理服务器的用途主要有两个： <BR>　 
<UL>
<LI><FONT color=#000066><B>WWW 网页代理人</B>：最主要的用途当然就是做为网页数据取得代理人，也就是说， Proxy 可以帮我们取得 Internet 上面的 WWW 数据就是了！那么能不能取得其它非 WWW 的资料呢？那就不一定了，要看 Proxy 主机是否有设定该服务。一般来说， Proxy 主要还是针对 WWW 网页的代理取得；</FONT> </LI></UL><FONT color=#000066>　</FONT> 
<UL>
<LI><FONT color=#000066><B>做为 Intranet 的单点对外防火墙系统</B>：就如同前面的图示， Proxy 如果架设在 Intranet 对外的连接点上面，那么他就可以被用来做为『应用层』阶段的防火墙了！而且，这个时候不需要设定 <A href="http://linux.vbird.org/linux_server/0320nat.php">NAT</A> 就可以让 Intranet 内部的私有 IP 的计算机连接上 Internet 了！这是因为您想要的数据是向 proxy 要求，所以真正去取得数据的人是『Proxy』而不是你的计算机啊！所以，只要 Proxy 可以接受私有 IP 的计算机要求，那这些私有 IP 的计算机就可以连上 WWW 啦！不过，也由于 Proxy 为一个 应用层 阶段的防火墙系统，所以，他并无法进行较低阶的封包过滤！因此，在内部计算机想要透过 Proxy 来取得邮件、或者是其它的服务，呵呵！那就比较麻烦，简直就是麻烦的多啦！</FONT> </LI></UL>　 <BR>由于 Proxy 的这种特性，让他很常被使用于大型的企业内部，因为可以达到杜绝内部人员上班时使用非 WWW 以外的网络服务，而且还可以监测使用者的资料要求流向与流量呢！很不错吧！ ^_^好了，接下来我们来谈一谈 Proxy 主要的优缺点吧： <BR>　 
<UL>
<LI><B><FONT color=#000066>快速的存取动作</FONT></B>：一般来说， Proxy 主机的频宽以及硬件配备会比较高档！所以 Proxy 最大的优点就是可以提供客户端较为快速的浏览！咦！但是我们向 Proxy 要求数据的时候， Proxy 不是会自行再储存一份吗？这样不是会多花很多时间？是这样没有错，但是，换一个角度来想，<FONT color=#000066>如果在第一位使用者要求过 A 数据后，由于 Proxy 就会自动放一放 A 数据在 Cache 当中，之后的所有使用者只要是重复要求这个 A 数据， Proxy 可以立刻将数据传给使用者</FONT>，您瞧！这样这个 Client 等于是直接向 Proxy 取得这份 A 资料了！是否更加的快速！这是因为 Proxy 就在您的 Intranet 之内，传输速度可是相当快的！这也就是说：如果您要设定代理服务器的时候，<FONT color=#000066>一定要找距离我们的机器最近的那一部</FONT>，否则就没有达到代理服务器的功用了！通常快速的存取动作最明显的大概是连去国外的网站了！这里要强烈的建议，<FONT color=#000066>如果你需要连上国外的网页，请一定使用代理服务器，因为不但可以节省频宽，并且速度上会快上很多很多 ( </FONT>例如美国环保署, EPA 网站！ ) </LI></UL>　 
<UL>
<LI><B><FONT color=#000066>降低网络的负荷</FONT></B>：由于我们是向代理服务器要求数据，如果代理服务器内刚好有你要的数据，将会直接传给你，则你的要求将不会到真实的那一个网页去 ( 除非你在 IE 内按下『重新整理』这个按钮 ) ，而如果没有你要求的数据，那他也会去捉一份你要的数据给你，并存下来，以后如果有与你相同需要的用户，那他就可以直接传送给用户，如此当可降低网络的负荷！(也就是上面<A href="#fig_02">图二</A>的 step 1, 2, 3, 4 ) </LI></UL>　 
<UL>
<LI><B><FONT color=#000066>资料分流</FONT></B>：由于各家 ISP 对于不同国家的频宽是有差异的，因此，假设如果您要去美国时使用 Proxy1 速度较快，而 Proxy2 则是去日本比较快，至于台湾本地则 Proxy3 较快，如此一来，我们可以透过设定将不同目标的代理服务器分开来，以达到分流的目的！则你的网域中将可以达到很好的分流效果，网络『感觉上』会比较快速喔！ </LI></UL>　 
<UL>
<LI><B><FONT color=#000066>提供防火墙内部的计算机连上 Internet</FONT></B>：这个是一般企业比较常用的情况！由于企业内部害怕被黑客侵入，通常会设立一些比较严密的防火墙，然而如此一来公司内部的计算机可能面临无法连上 Internet 的窘境，那使用 proxy 让你的内部计算机可以透过这一架主机的代理服务而取得 Internet 上的信息，就是一个很好的方法啦！ </LI></UL>　 
<UL>
<LI><B><FONT color=#000066>多层次的管道 ( 上层代理服务器 )</FONT></B>：代理服务器可以提供多重的管道设定，例如，当你需要国内的数据时，代理服务器将直接去捉取，而需要国外的数据时，才连到上一层的代理服务器！如此将可达到你的需求 ( 而不用常常在你的 IE 等浏览器上更改所需的代理服务器 ) ，这个部分我们在底下还会进行额外的说明。 </LI></UL>　 <BR>有利就有弊，当然 Proxy 也不是万能的天神～他有什么可能潜藏的缺点呢？ <BR>　 
<UL>
<LI><B><FONT color=#000066>容易为 Intranet 的内部人员滥用</FONT></B>：因为 Proxy 是对内部的计算机捉取数据 ( 当然也可以对 Internet 上面的使用者捉取数据啦！ ) ，而且在 Internet 上面看到的实际上是你的 Proxy 在捉资料喔！如果你的使用者大量的以浏览器下载 A 图啊，还是透过你的 Proxy 干坏事啦，这样一来可就累了～因为实在不容易轻易的管理！所以，为了杜绝这个状况，强烈的建议多加安装登录档案分析的软件，在管理上面会轻松很多喔！ </LI></UL>　 
<UL>
<LI><B><FONT color=#000066>需要较高超的设定技巧与除错程序</FONT></B>：在鸟哥设定过的 Server 当中， Proxy 算是比较不容易设定好『效能』的一个服务器了！由上面的传输过程中，您不难发现 Proxy 的 Cache 与他的『上层代理服务器』的关系是很紧密的，万一设定错误的话，很有可能反而让您的 Proxy 拖垮 WWW 的浏览速度！最严重的是造成无法联机 ( 在上层 Proxy 与您的 Proxy 之间构成 loop 而跑不出去！ )，因此，这对于管理员来说是比较困扰的一件事。 </LI></UL>　 
<UL>
<LI><B><FONT color=#000066>可能会取得旧的错误数据</FONT></B>：由前面的 Proxy 运作过程当中不难发现，Client 端向 Server 端求取资料时，Server 会先向自己的 cache 查寻，如果有该索求数据，就立即将数据送给 Client 。现在假设个例子来说明，万一我的网页三天两头改变一次，那么那个 cache 事实上并没有天天更新啊！这个时候， Client 端所取得的数据就有可能是网页修改之前的旧数据咯！所以，使用者得常常按下『更新』才能取得新的资料啊！ </LI></UL>　 <BR>总之， Proxy 的优点是很多的，但是缺点却需要网管人员的操心啊！ <BR>　 <BR>
<HR width="100%">
<A name=theory_parent_proxy></A><FONT color=#000099 size=+1>什么是上层代理服务器？哪里有上层代理服务器</FONT> <BR>　 <BR><B><FONT color=#000099>什么是上层代理服务器：</FONT></B> <BR>好了，上面提到过所谓的『上层代理服务器』这又是什么咚咚？事实上，上层代理服务器就是一个 Proxy 啦，只是，我们自己设定的这个区域 Proxy 会将自己当作 Client 而去要求另外一个 Proxy 求取数据来给我们的使用者就是了！整个流程图可以这样看： <BR>　 
<CENTER><IMG height=116 src="71_files/0420squid_proxy3[1].jpg" width=640 nosave=""> <BR><A name=fig_03></A><FONT color=#000066>图三、上层 Proxy 示意图</FONT></CENTER>　 <BR>就是我们的 Local proxy 并不会主动的去捉数据，而是透过『上层代理服务器』去向 Internet 要求资料！这样有什么好处呢？刚刚上面也曾经提过了，由于这些上层代理服务器才是真正对外频宽最大的几部机器之一，所以透过他来要求数据一定又比我们的 Local proxy 还要来的快啊！所以我当然会喜欢设定上层 Proxy 噜！这个现象最常发生在对国外的联机上面，有没有设定 Proxy 差异是相当大的呢！上层代理服务器除了频宽更大之外，还有没有什么好处啊？当然有，最大的好处就是达到分流的效应！例如下图的说明： <BR>　 
<CENTER><IMG height=346 src="71_files/0420squid_proxy4[1].jpg" width=488 nosave=""> <BR><A name=fig_04></A><FONT color=#000066>图四、上层代理服务器的分流动作示意图</FONT></CENTER>　 <BR>我总共设定了三个上层代理服务器，由于这三个代理服务器对外的速度都不相同，所以，当我要去美国时，就以 Proxy1 来要求资料，要连欧洲就以 Proxy3 ，至于要连日本，就以 Proxy 2 来要求我所需要的数据，如此一来，呵呵！可以让我的 Proxy 达到最佳的效能喔！很不错吧！ ^_^！所以上层代理服务器是很重要的呢！ <BR>　 <BR><B><FONT color=#000099>哪里有上层代理服务器？</FONT></B> <BR>目前有哪些流量大、然后又开放出来的 Proxy 呢？我这里举几个网页给大家参考参考： <BR>　 
<UL>
<LI><A href="http://service.seed.net.tw/dial/server.shtml" target=_blank>SeedNet 的代理服务器(http://service.seed.net.tw/dial/server.shtml)</A>； 
<LI><A href="http://www.hinet.net/support/new_adsl04.htm" target=_blank>Hinet 的代理服务器(http://www.hinet.net/support/new_adsl04.htm)</A>； 
<LI><A href="http://turtle.ee.ncku.edu.tw/~tung/proxy/proxylst.html" target=_blank>一些台湾学术网络的代理服务器(http://turtle.ee.ncku.edu.tw/~tung/proxy/proxylst.html)</A>。 </LI></UL>　 <BR>由前面的介绍中，我们不难发现 Proxy 有可能会被 Client 端过度的滥用，同时也有可能会被拿来为非作歹啊！所以，目前绝大部分的 Proxy 已经『停止对外开放』了，仅针对自己的网域内的 Client 提供 Proxy 的服务而已～因此，如果您要自行设定 Proxy 的时候，请记得去您当初申请网络的 ISP ( 如果是学术单位，就到上面介绍的学术网络查看看即可！) 查寻一下，才能比较有效的设定好您的主机喔！因为设定错误的话，呵呵！上层 Proxy 根本不提供服务，或者是上层 Proxy 的效能并不好，那个时候您的 Proxy 也会连带的受到很大的影响啊！慎选！慎选！ <BR>　 <BR>
<HR width="100%">
<A name=theory_yesorno></A><FONT color=#000099 size=+1>我是否一定要设定 Proxy ？</FONT> <BR>　 <BR>话又说回来，到底我应不应该设定 Proxy 呢？还是得由理论与实际上的状态来进行说明。事实上，我们的 Proxy 感觉上会加快传输的速度，主要的因素是来自于 cache 已经记录了一份数据了，所以 Client 端取得的其实是这一份资料，而不是真的来自于 Internet 上面的实时数据！这样的好处前面提过了，就是可以增加内部网络传输的效能啊！但是，这要在一个前提之下，就是我的使用者很多时，那么由于来自四面八方的人会四处去求取资料，让我的 Cache 拥有较大的数据库，那么内部传输的速度自然就会有所帮助！所以，要架设 Proxy 的情况可以是： <BR>　 
<UL>
<LI><FONT color=#000066>我的 Client 端用户不少，而且大部分仅需要 WWW 这个网络服务而已；</FONT> 
<LI><FONT color=#000066>我的 Proxy 还兼做防火墙的任务；</FONT> 
<LI><FONT color=#000066>我的 Client 端常常需要联机到传输速度很慢的网站，例如国外的网站；</FONT> 
<LI><FONT color=#000066>我的 Client 端常常浏览的网站是『静态』网站，而不是动态网站(例如讨论区的 PHP )。</FONT> </LI></UL>　 <BR>相反的来说，要是 (1)我的 Client 端很少，那么每次上去 WWW 都是求取新的资料，有没有 Proxy 反而看不出效益～此外，(2)Proxy 由于属于应用层了，对于 Internet 的规划上弹性较不足！不像 NAT 主机可以进行很多的功能！(3)我常常上的网站是类似讨论区那种一日多变的网站，在这样的情况下，实在是没有必要架设 Proxy 的！ <BR>　 <BR>但是，如果对于学校单位那原本频宽就不足的环境中，架设 Proxy 来让校内的网络速度提升，呵呵！就是有那个必要性的啦！所以要不要架设 Proxy 呢？请好好的依据您的环境来考虑喔！ <BR>　 <BR>
<HR width="100%">
<A name=theory_hardware></A><FONT color=#000099 size=+1>所需要的硬件要求与最佳硬件配置方式</FONT> <BR>　 <BR>假设您一定需要架设 Proxy ，那么到底什么样的配备是必需的呢？我们刚刚提到 Proxy 对于硬件的要求相当的高！因为我们架设 Proxy 的目的就是希望能够加快网络的传输效能嘛！因此，虽然 Proxy Server 几乎在任何的 Linux 系统上面都能跑 ( 例如我的 P 133 MMX ) ，但是您的 Proxy Server 最好还是能有以下的硬件等级： <BR>　 
<UL>
<LI>CPU 最好能够 P III 550 以上等级； 
<LI>RAM 最好能够大于 512 MB ，这也是很重要的一个硬件参数！ 
<LI>Hard Disk 最好能用 SCSI 接口的，因为速度与稳定度都比较好！如果不能的话，那么 IDE 接口的硬盘由于目前速度也越来越快，所以使用 IDE 也没有问题，但是最好是『<FONT color=#000066>多颗硬盘</FONT>』的架构，例如我总共需要 30 GB 的硬盘空间，那么最好是 10 GB 的硬盘三颗这样的架构较佳！为什么呢？由于 cache 对于 Proxy 的重要性相当的大，所以 <FONT color=#000066>cache 读取速度越快的话，代表 Proxy 的效能也会越好</FONT>！那由于 Proxy 对每笔资料写入 cache 时，是『<FONT color=#000066>平均分摊在各个 cache 的目录中</FONT> 』，所以当然硬盘数越多越好！例如我原本有 10 MB 的数据要写入 cache ，那么这 10MB 写入同一颗硬盘快？还是 10MB 被分散写入三颗硬盘，因此每一颗硬盘仅记录 3.3MB ，那一个快？当然是三颗硬盘的架构会比较快，因为我有三个磁头在帮我写入数据嘛！^_^！请注意喔！<FONT color=#000066>这里我们说的是『多颗硬盘』而不是『多个 Partition 』喔</FONT>！因为如果我将 30GB 的硬盘切割成三块 partition 的状态下，由于还是只有一个磁头啊，所以写入的速度差异不会很大！这里要特别留意与了解呢！ 
<LI>网络卡与网络周边最好使用 GBytes 的网络卡，当然啦，一般的公司行号应该不需要用到这样的网络卡才是！我这里指的是较高档的配备啦！ </LI></UL>　 <BR>事实上，最重要的还是 RAM 与 HD 这两样，当然，网络接口也绝对不能忽视就是了！针对硬盘来说，最好使用 SCSI 这个稳定的接口，当然，使用 IDE 也是不错啦！但是要注意保养就是了。此外，就如同上面提到的，在硬盘的架构上是相当的重要的！一般来说，使用磁盘阵列应该是不错的想法，如果没有办法的话，使用多颗硬盘取代单颗硬盘的架构，在效能上也会有不错的显著提升呢！ <BR>　 <BR>既然硬盘这么重要，我们也约略谈一谈硬盘的基础规划应该有哪些需要注意的呢？ <BR>　 
<UL>
<LI><FONT color=#000066>最好在架设 Proxy 时，将整体主机的规划做好，并且让 Proxy 主机的服务简单一点，就是仅负责 Proxy 就好了！</FONT> 
<LI><FONT color=#000066>每颗硬盘的容量不需要太大，大约在 9 GB 以内即可，此外，最好将硬盘分割一下，一块 Partition 差不多在 2~4 GB 之间即可，因为切太大的话数据的搜寻耗费时间较长，但是 Partition 太小又可能造成空间的浪费～所以差不多的大小就限制在 2~4 GB 吧！</FONT> 
<LI><FONT color=#000066>我们刚刚上面有提过，cache 是放置在某个目录下的，而最好一个目录底下就是独立的一个 partition 。此外，由于 cache 所在的硬盘常常会有数据的存取，因此可能此一硬盘的损耗率会比较大，所以这个 cache 所在的硬盘最好不要跟重要数据文件，例如 /, /etc, /usr, /home 等等重要的系统档案放在一起，以免危险啊！</FONT> 
<LI><FONT color=#000066>也由于 cache 所在的硬盘数据存取太密集了，所以，硬盘的选择上面需要 (1)转速不能太低； (2)磁头的机械臂需要可以忍受频繁的动作； (3)发热量不可太大，或者可以考虑加装硬盘用风扇。</FONT> </LI></UL>　 <BR>
<HR width="100%">
<A name=theory_proxynadnat></A><FONT color=#000099 size=+1>代理服务器与 NAT 主机的差异</FONT> <BR>　 <BR>或许您已经发现了一件事，那就是：在内部局域网络使用私有 IP 的 Client 端不论透过 Proxy 或者 NAT 均可以直接取得 WWW 这个 Internet 的服务，那么 NAT 与 Proxy 有没有什么不同的地方啊？他们不都是可以让内部的 Client 连接出去吗？其实这两个玩意儿差异性是『相当大』的： <BR>　 
<UL>
<LI><FONT color=#000066>NAT 是一个利用 TCP/IP 的 packet filter ( 封包过滤机制 )来进行封包处理的一个机制，所以他是『直接分析 TCP/IP 』，所以在设定防火墙的时候，他的弹性比较高，只要能过 NAT 这一关，那么大部分的网络服务都可以使用，因为 TCP/IP 是比较底层的协议啊！要知道的是，TCP/IP 上头还有 port 、还有 IP 等等的信息，单是 port 就可以让我们使用很多的不同的协议了！例如 port 20, 21 是 FTP 啊， 80 是 WWW 啊等等的！所以 NAT 能做的事情事很多的！</FONT> </LI></UL>　 
<UL>
<LI><FONT color=#000066>至于 Proxy 就不一样了， Proxy 主要透过类似 Squid 这一类的软件来达成的一个服务，基本上，一般来说他是透过 port 3128 来进行数据的监听与传输，单是看到这个 port 3128 就应该要晓得他仅是一个 daemon 而已。Proxy 已经是应用层这个阶段的网络项目了，所以他并没有去分析 TCP 的封包，只要 Client 来源合乎他的需求 (例如 IP 是被支持的 ) ，那么他将透过 daemon 的功能帮使用者达成使用者所想要的任务！所以说，能不能做某些事情，与 Proxy 服务器上面负责的那个 daemon 是有关的！万一 daemon 无法进行 FTP 数据的取得，那么您再怎么努力的尝试上网也是枉然的啊！</FONT> </LI></UL>　 <BR>这样说有没有比较有点概念了呢？NAT 是由较底层的网络去进行分析的工作，至于通过 NAT 的封包是干嘛用的， NAT 不去管他！至于 proxy 则主要是由一个 daemon 的功能达成的，所以必需要符合该 daemon 的需求，才能达到某些功能！ <BR>　 <BR>谈完了这些基本的原理之后，我们可得来玩一玩 Proxy 了吧？！事实上，目前有很多的 Proxy 软件，例如 <A href="http://linux.vbird.org/linux_server/0360apache.php">apache</A> 也有提供 proxy 模块的功能喔！但是，最好不要用 Apache 当作您的 Proxy server ，因为.....效能真的太差了～会让您的网络停顿的更厉害～目前 Proxy 的服务器软件当中，以 squid 这个咚咚最出名，会出名的原因是因为他的效能高！真的很不错的一套软件，所以底下我们就针对 squid 来做说明吧！</UL>
<HR width="100%">
<A name=package></A><FONT color=#000099 size=+1>套件安装</FONT> 
<UL>我们的 Proxy 服务器软件选择 squid 这个效能很高的套件来安装，目前 ( 2003/03 ) Squid 已经出到了 2.5 版了，您可以到官方网站上面下载，或者是到中山大学的 FTP 网站上面下载，底下提供一下联系的网址： <BR>　 
<UL>
<LI>官方网站：<A href="http://www.squid-cache.org/Versions/v2/2.5/" target=_blank>http://www.squid-cache.org/Versions/v2/2.5/</A> 
<LI>中山大学：<A href="http://ftp.nsysu.edu.tw/Unix/Proxy/squid/source/STABLE/" target=_blank>http://ftp.nsysu.edu.tw/Unix/Proxy/squid/source/STABLE/</A> </LI></UL>　 <BR>同样的， squid 也有两种主要的安装模式，分别是 RPM 版本与 Tarball 版本，不过，由于我们会加入一些不同的参数设定值，所以预设的 RPM 档案并无法满足我们的需求，除非使用 SRPM 来进行重新 configuration 的动作，否则比较不能让我们满意啦！因此，习惯上我们都是以 Tarball 的方式来进行编译、设定与安装，所以底下鸟哥会比较偏重以 Tarball 的安装来进行介绍，如果有兴趣的话，可以尝试以 SRPM 进行修订的工作喔！ <BR>　 <BR>
<HR width="100%">
<A name=package_rpm></A><FONT color=#000099 size=+1>使用 RPM 方式安装 squid</FONT> <BR>　 <BR>一般来说，使用您的 Linux distribution 提供的 Squid 也就够了，但是，就如同上面提到的，可能会有一些设定值您无法自由自在的设定，不过。不过，无论如何，以 RPM 来安装是最简便的啦！那么就请拿出您的原版光盘，将他 Mount 上来，查询一下是否有 squid 字样的文件名称？没错，就将他安装上去吧！目前主要的几个 distribution 都有提供这个套件，所以应该可以很快的找到这个套件才是！怎么使用 RPM 呢？没这么难吧！ <BR>　 
<TABLE cols=1 width=550 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]#</FONT><FONT color=#ffff00> rpm -ivh squidxxxxxxx</FONT></FONT></TD></TR></TBODY></TABLE>　 <BR>一再地强调， RPM 是粉重要的，请好好的使用他吧！ ^_^！这个指令就安装完毕！只是要注意的是，由于 squid&nbsp; 2.2 版以前的设定与 2.4 版以后的设定差异性很大，所以请特别留意您的 squid 版本，如果是使用旧的 Linux distribution 的使用者，例如 Red Hat 6.xx 版本，或者是 Mandrake 7.xx 版本，那么就不要再以 RPM 来升级了！直接使用底下的 Tarball 吧！反正才安装一个档案，还不会太难啦！ <BR>　 <BR>
<HR width="100%">
<A name=package_tarball></A><FONT color=#000099 size=+1>使用 Tarball 方式安装 squid</FONT> <BR>　 <BR>一般来说，我还真是蛮喜欢中山大学的 FTP 站 ( 怪了，好像一直在帮人家打广告！ ^_^ ) 没办法，我们南部人嘛！当然是南部的 FTP 站比较亲切！这个时候，您可以直接在 Linux 底下使用 wget 来取得我们所需要的 squid 喔！目前我取得的版本是 2.5.STABLE2 版本，取得的方法如下：(注：您也可以到鸟哥的私房菜下载 <A href="http://linux.vbird.org/download/index.php#squid_ap">http://linux.vbird.org/download</A>) <BR>　 
<TABLE cols=1 width=550 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]#</FONT><FONT color=#ffff00>&nbsp; wget&nbsp; \</FONT></FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>http://ftp.nsysu.edu.tw/Unix/Proxy/squid/source/STABLE/squid-2.5.STABLE2.tar.gz</FONT></TD></TR></TBODY></TABLE>　 <BR>好了，这个档案应该就是 /root/squid-2.5.STABLE2.tar.gz ！那么就开始来给他安装吧！过程很简单啦，重要的地方只有在下达 ./configure 的地方需要很多的额外参数支持就是了！ <BR>　 
<TABLE cols=1 width=550 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun color=#ffffcc size=-1>0. 解压缩：</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]# </FONT><FONT color=#ffff00>cd /usr/local/src</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test src]# </FONT><FONT color=#ffff00>tar -zxvf /root/squid-2.5.STABLE2.tar.gz</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># ....(略)....会产生一个 squid-2.5.STABLE2 的目录</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test src]# </FONT><FONT color=#ffff00>cd squid-2.5.STABLE2</FONT></FONT> <BR><FONT face=SimSun color=#ffffff size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>1. 开始设定参数：</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test squid-2.5.STABLE2]# </FONT><FONT color=#ffff00>export CFLAGES='-O2 -mcpu=i586'</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 这是一个额外的参数啦！因为我们使用的是 Linux ，而我们的 GNU gcc&nbsp;</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 有针对每种不同的 CPU 来进行套件的最佳化编译！所以啦，就加入我们的</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># CPU 型号吧！因为我的 CPU 是 P-166 ，反正是个小案例啦！所以才会是 i586，</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 您的 CPU 只要超过赛扬等级以上，就会是 i686 ！此外，除了</FONT> <BR><FONT face=SimSun color=#ffff99 size=-1># i386, i486, i586, i686 还有 pentium, pentium3, pentium4, athlon,&nbsp;</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffff99># athlon-tbird, athlon-4, athlon-x, athlon-mp, k6, k6-2, k6-3</FONT><FONT color=#ff6666> 等等！</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 如果不确定您的 CPU 那么就用 ix86 之类的方式来命名吧！不过，即使没有</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 写入这个参数也无所谓啦！至于那个 O2 是最佳化参数啦！</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>　</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test squid-2.5.STABLE2]# </FONT><FONT color=#ffff00>./configure --prefix=/usr/local/squid&nbsp; \</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>&gt; </FONT><FONT color=#ffff00>--enable-gnuregex --enable-async-io=80 --enable-icmp \</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>&gt; </FONT><FONT color=#ffff00>--enable-kill-parent-hack --enable-snmp&nbsp; \</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>&gt;</FONT><FONT color=#ffff00> --disable-ident-lookups --enable-cahce-digests \</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>&gt;</FONT><FONT color=#ffff00> --enable-err-language="Traditional_Chinese"&nbsp; \</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>&gt;</FONT><FONT color=#ffff00> --enable-poll --enable-linux-netfilter</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 这个咚咚就有趣啦！因为实在有相当多的参数可以使用，你可以使用&nbsp;</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># ./configure --help 来察看可以使用的许多参数啊！稍微解释一下各个设定值：</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffff99><B>--prefix=/usr/local/squid</B>：</FONT><FONT color=#ff6666>未来程序编译完成后放置的安装目录；</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1><B>--enable-gnuregex</B>：使用 GNU 提供的正规表示法的原则来进行编译，请注意，</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>　　因为在 Proxy 未来的规划当中，很可能会动用到正规表示法的方式来</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>　　抵挡一些恶意的网站，所以这里应该要加入这个参数的！</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffff99><B>--enable-async-io=80</B>：</FONT><FONT color=#ff6666>这个项目主要在控制一些输出入的组件，使用这个项目</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>　　可以让您的 Proxy 效能提升很多喔，因为是异步输出 (async) 的模式啊！</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>　　后面接的数值是可以变动的，如果您的网站配备很高档，可以尝试将这个数字</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>　　提升到 160 以上，如果是小网站的话，那么可以考虑将他降低至 40 左右。</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffff99><B>--enable-icmp</B>：</FONT><FONT color=#ff6666>要不要支援 ICMP 啊！当然是要的！</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffff99><B>--enbale-kill-parent-hack</B>：</FONT><FONT color=#ff6666>在我关掉 squid 的时候，要不要连同</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>　　parent process 一起关掉，当然也是要的啦！</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffff99><B>--enable-snmp</B>：</FONT><FONT color=#ff6666>这个与制图的 MRTG 比较有关啦！如果没有用到的话，</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>　　可以考虑将这个项目拿掉也没有关系！</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffff99><B>--enable-cache-digests</B>：</FONT><FONT color=#ff6666>这个项目很重要的啦，我们在底下再进行说明。</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffff99><B>--enable-err-language="Traditional_Chinese"</B>：</FONT><FONT color=#ff6666>不需要写了吧？</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>　　只要有任何的错误讯息，网页上面显示的语系会是中文喔！</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffff99><B>--enable-poll</B> ：</FONT><FONT color=#ff6666>可以提升效能；</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffff99><B>--enable-linux-netfilter</B>：</FONT><FONT color=#ff6666>可以增加通透式 Proxy 的设定！后面再提啦！</FONT></FONT> <BR><FONT face=SimSun color=#ffff99 size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>2. 开始编译以及 Install ！</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]# </FONT><FONT color=#ffff00>make &amp;&amp; make install</FONT></FONT> <BR><FONT face=SimSun color=#ffffff size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>3. 开始设定其它的相关参数</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]# </FONT><FONT color=#ffff00>vi /etc/man.config</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 在这个档案当中新加入一行：</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffff00>MANPATH /usr/local/squid/man&nbsp;&nbsp;</FONT><FONT color=#ff6666> # 与 Squid 有关的 man page</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 可以让 squid 提供的说明文件让 man 指令可以查到！</FONT></TD></TR></TBODY></TABLE>　 <BR>就这样几个简单的步骤就将 squid 给他安装完毕啦！很快速吧！所以我说，使用 Tarball 来安装 squid 其实是很快的，不用太担心！</UL>
<HR width="100%">
<A name=server></A><FONT color=#000099 size=+1>Server 端设定：</FONT> 
<UL><FONT color=#000000>终于来到了主机端的设定项目啦！以下我们会分门别类的介绍各个主要的参数值，这些参数不见得适合您的 Proxy 环境，所以使用的时候敬请特别小心喔！每个项目都要好好的了解一下龋×硗猓底下我主要是以 Tarball 安装的目录为主要的介绍状态，如果您是以 RPM 来安装的话，那么所有的档案原理与设定还是一样的，只不过档案存放的路径就不太一样就是了！请以 RPM 的指令或者是 locate 与 find 的方式找出来您的设定档吧！</FONT> <BR><FONT color=#000000>　</FONT> <BR>
<HR width="100%">
<A name=server_contr></A><FONT color=#000099 size=+1>squid 的结构</FONT> <BR><FONT color=#000000>　</FONT> <BR><FONT color=#000000>刚刚安装的目录其实是在 /usr/local/squid 这个目录下，而这个目录又分为几个主要的子目录，分别为：</FONT> <BR><FONT color=#000000>　</FONT> 
<UL>
<LI><FONT face=SimSun color=#000066>bin/ ：放置主要的 squid 执行 scripts 的目录，重要的是 RunCache 那个档案；</FONT> 
<LI><FONT face=SimSun color=#000066>etc/ ：几乎所有的 squid 设定档都在这里；</FONT> 
<LI><FONT face=SimSun color=#000066>libexec/ ：一些函式库；</FONT> 
<LI><FONT face=SimSun color=#000066>man/ ：就是一些在线文件查寻档啦！</FONT> 
<LI><FONT face=SimSun color=#000066>sbin/ ：重要的就是那个 squid 的执行档！</FONT> 
<LI><FONT face=SimSun color=#000066>share/ ：一些错误讯息代码表示档案，以及一些小图标放置的目录；</FONT> 
<LI><FONT face=SimSun color=#000066>var/ ：预设是放置 log file 的，不过我不喜欢放在这里，这点等一下我们会修改的！</FONT> </LI></UL><FONT color=#000000>　</FONT> <BR><FONT color=#000000>那么主要的设定档有哪些呢？其实可以说只有两个啦：</FONT> <BR><FONT color=#000000>　</FONT> 
<UL>
<LI><FONT face=SimSun color=#000066>/usr/local/squid/etc/squid.conf</FONT><FONT color=#000000> ：这个是主要的设定档，所有的 squid 所需要的设定都是放置在这个档案当中的！鸟哥底下提到的种种设定方法几乎都是这个档案里面的说明喔！所以，如果您英文不错，那么就直接看一下这个档案就知道如何设定 squid 啦！</FONT> 
<LI><FONT face=SimSun color=#000066>/usr/local/squid/etc/mime.conf</FONT><FONT color=#000000> ：这个档案则是在设定 squid 所支持的 Internet 上面的档案格式，就是所谓的 mime 格式！一般来说，这个档案的预设内容已经能够符合我们的需求了，所以不需要更动他，除非您很清楚的知道您所需要额外支持的 mime 档案格式。</FONT> </LI></UL><FONT color=#000000>　</FONT> <BR><FONT color=#000000>而执行档其实只有一个，那就是 squid 啦！不过， Squid 这个套件额外的提供了两个可执行的 scripts 来帮助大家执行 squid ，那就是在 bin/ 里面的 RunAccel 与 RunCache ：</FONT> <BR><FONT color=#000000>　</FONT> 
<UL>
<LI><FONT face=SimSun color=#000066>/usr/local/squid/sbin/squid</FONT><FONT color=#000000> ：就是我们说的 squid 的执行档！要知道这个指令的参数吗？就使用『</FONT><FONT face=SimSun color=#000066> ./squid --help</FONT><FONT color=#000000> 』就能知道有什么参数啦！</FONT> 
<LI><FONT face=SimSun color=#000066>/usr/local/squid/bin/RunCache</FONT><FONT color=#000000> ：这个是主要的执行 squid 的一支简单的 script ，主要是利用 squid.conf 设定档案的内容来启用 squid 喔！</FONT> 
<LI><FONT face=SimSun color=#000066>/usr/local/squid/bin/RunAccel</FONT><FONT color=#000000> ：如果您的 WWW 服务也想要透过 Squid 来进行『加速』的话，那就可以使用 RunAccel 来取代 RunCache 了，不过，我通常还是使用 RunCache 而已！</FONT> </LI></UL><FONT color=#000000>　</FONT> <BR>
<HR width="100%">
<A name=server_permissions></A><FONT color=#000099 size=+1>squid 的 process owner 与 cache directory owner</FONT> <BR><FONT color=#000000>&nbsp;　</FONT> <BR><FONT color=#000000>我们前面的原理部分稍微提过， squid 主要是以 daemon 提供的 Proxy 功能，而这个 daemon 最大的功能就是将 Internet 上面捉取的数据给他放入 Cache 目录当中啦！而由于 daemon 会产生一些 processes ( 程序 )，这些程序都会有 Owner 以及 Group 。这样晓得我要讲什么了吧？呵呵！没错，那个放置 cache 的目录 ( 底下简称 cache dir ) 的拥有者以及拥有群组就必需要与 squid 产生的 process 的拥有者与群组相同才行！而为了保险起见，通常 squid 不会以 root 来启动，最好是以 nobody 或者是一些权限比较低的系统账号来启动他！假设我们的 squid 这个 daemon 是由 nobody 所启动的好了，而假设我的 cache dir 是放置在 /var/spool/squid 下面，则这个 /var/spool/squid 的 Owner 与 group 就必需要是 nobody, nobody 才行！这个很重要喔！因为大部分无法启用 squid 的朋友都是这个动作没有搞正确的原因啊！</FONT> <BR><FONT color=#000000>　</FONT> <BR><FONT color=#000000>squid 的 Owner 与 Group 是在 squid.conf 里面设定的，而至于 cache dir 则是需要我们手动来设定好他的权限呢！</FONT> <BR><FONT color=#000000>　</FONT> <BR>
<HR width="100%">
<A name=server_basic></A><FONT color=#000099 size=+1>最简易的 squid 设定方法</FONT> <BR>　 <BR><FONT color=#000000>设定 squid 仅要修改一个档案而已，那就是 </FONT><FONT face=SimSun color=#000066>/usr/local/squid/etc/squid.conf</FONT><FONT color=#000000> ( RPM 版本就不相同！请自行找出来吧！ )！请注意，在这个例子当中，我们并没有介绍高档配备的设定，仅只是列出重要的设定项目还有一些观念，您所想要的设定必需要视您的主机规划而定，例如 cache dir 每个人所放置的目录都不相同啊，所以直接拿我的设定来启动时，可能会完蛋啊！请注意需要修改成您所想要的样式才行！好了，在这个小节当中，我们仅列出来几个一定要设定的参数，至于更进阶的参数将留待后面分别介绍。</FONT> <BR><FONT color=#000000>　</FONT> <BR><FONT color=#000000>另外要额外提醒的是，在 squid.conf 这个档案当中，预设的情况下是『</FONT><B><FONT color=#000066>除了本机可以使用 squid 的少部分功能外，其它所有的项目都没有被启动</FONT></B><FONT color=#000000>』，所以您必需以 vi 的搜寻功能找到下列的设定项目后，将批注符号 (#) 拿掉，或者是自行输入底下的设定才行喔！不唆，马上进行吧！</FONT> <BR>　 
<TABLE cols=1 width=550 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]#</FONT><FONT color=#ffff00> cd /usr/local/squid/etc</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]#</FONT><FONT color=#ffff00> vi squid.conf</FONT></FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 1. 关于网络的参数设定部分</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 　 在这个部分当中，最重要的就是启用 squid 这个 daemon 的 port 了！</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　在预设的情况下，公认的标准 proxy port 为 3128 ，至于被查询封包</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　观察的则是 3130 这个 port，这里我们分别启用这两个 port ！如果您的</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　Proxy 还有帮人家代理 https 这个由 SSL 协议启用的 port ，那么还需要</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　启动 https_port ，但是我们这里不谈论 SSL 啦！太危险了～</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>http_port 3128</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>icp_port&nbsp; 3130</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 2. 设定快取目录 ( Cache dir ) 的大小与记录档案所在的目录</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　这个设定是重要到爆的地方，一定得设定正确才行啊！上面我们不是</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　提过关于硬盘与目录吗？好了，现在这样假设：我有两块 partition ，</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　这两块 partition 分别挂载在 /usr/local/squid/var/cache1</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　以及 /usr/local/squid/var/cache2 这两个区域，此外，两块&nbsp;</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　partition 一块为 1GB (cache1) 另一块为 2 GB (cache2) ，则设定为：</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>#　　&lt;cache_dir&gt; &lt;aufs|ufs&gt; &lt;目录所在&gt; &lt;MBytes大小&gt; &lt;dir1&gt; &lt;dir2&gt;</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　那个 aufs 只有在编译的时候加入 --enable-async-io 那个项目才有支持，</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　至于目录所在地与所占用的磁盘大小则请视您的主机情况而定，</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　而后面 dir1, dir2 则是两个次目录的大小，通常 16 256 或 64 64 皆可，</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　一般来说，数字最好是 16 的倍数，据说效能会比较好啦！</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　注意1：下面两行需要『视您的主机环境而定！』不要照抄！</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　注意2：在底下的例子中，我的两块 partition 已经 mount 上该目录了！</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　　　　　这也就是说，底下的两个目录是『已经存在的！』</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_dir aufs /usr/local/squid/var/cache1 1000 16 256</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_dir aufs /usr/local/squid/var/cache2 2000 16 256</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　底下则是关于记录文件的放置目录与文件名！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_access_log /usr/local/squid/var/logs/access.log</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_log /usr/local/squid/var/logs/cache.log</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_store_log /usr/local/squid/var/logs/store.log</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>pid_filename /usr/local/squid/var/logs/squid.pid</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 3. 关闭认证机制</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　不晓得为什么，这一版的 squid 会自动的加入认证机制，请找到底下</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　几行，将他 mark 起来！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>#auth_param basic children 5</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>#auth_param basic realm Squid proxy-caching web server</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>#auth_param basic credentialsttl 2 hours</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 4. 提供 squid 服务</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　预设的情况下，仅有本机可以使用 squid ，我们先将所有的权限开放</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　然后在一个一个的关闭！先找到底下这一行：</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>http_access deny all</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　将他改成</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>http_access allow all</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 5. 设定 squid 的拥有者与系统管理员信箱：</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　就是刚刚我们上一小节提到的 squid 的拥有者，请注意，这个</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　user 与 group 必需要在 /etc/passwd 及 /etc/group 里面存在方可成功！</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　我这里以权限最小的 nobody, nogroup 来做为范例，您也可以自行设定！</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　另外，cache_mgr 则是 squid 管理员的信箱，当 squid 发生问题时，</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　屏幕上就会出现这个信箱给使用者联系管理员之用！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_effective_user&nbsp;&nbsp; nobody</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffff00>cache_effective_group&nbsp; nogroup&nbsp; </FONT><FONT color=#ff6666># 您也可以改成 nobody ！</FONT></FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_mgr youraccount@your.e.mail</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 6. 变更目录权限：</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　在预设的情况下，我们主要的纪录信息都写入 /usr/local/squid/var 里面，</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　所以这个时候需要将这个目录的权限改变成为 nobody 与 nogroup 所有！</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　当然，如果您的 cache_dir 不在这个目录当中，那么还需要额外自行建立，</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　例如我的 cache_dir 万一是在 /proxy1 与 /proxy2 时，那么我就必需要：</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　chown -R nobody:nogroup /proxy1</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　chown -R nobody:nogroup /proxy2</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　关于权限的问题是很重要的！请不要忘记了！</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]#</FONT><FONT color=#ffff00> chown -R nobody:nogroup /usr/local/squid/var</FONT></FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 7. 开始启动 squid：</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　启动 squid 来试看看吧！不过，首先我们必需要建立快取目录的格式</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　才行，此外，由于我们想要以 nobody 来启动 squid ，所以你需要这样：</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]# </FONT><FONT color=#ffff00>/usr/local/squid/sbin/squid -z </FONT><FONT color=#ff6666># 建立 cache_dir</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]#</FONT><FONT color=#ffff00> su nobody -c "/usr/local/squid/bin/RunCache &amp;"</FONT></FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 8. 查看是否真的启动了 squid 了？</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]#</FONT><FONT color=#ffff00> netstat -tln | grep 3128</FONT></FONT> <BR><FONT face=SimSun color=#ffffff size=-1>tcp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 0.0.0.0:3128&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0.0.0:*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LISTEN</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 9. 重新读取设定档 squid.conf 的方法：</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]#</FONT><FONT color=#ffff00> /usr/local/squid/sbin/squid -k reconfigure</FONT></FONT></TD></TR></TBODY></TABLE>　 <BR>在上面的设定中，重要的地方在于： <BR>　 
<UL>
<LI><FONT color=#000099>你的硬盘规划与 cache_dir 的设定是否吻合</FONT>：请注意，除非您是『架设着玩的，纯粹锻炼功力』的角度来设定 Proxy ，那么可以直接以预设的设定来搞定您的 cache_dir ，不然的话，前面我们提过，这个 Cache dir 可是影响 Proxy 效能的相当重要的因素之一，因此，千万不可大意啊！ </LI></UL>　 
<UL>
<LI><FONT color=#000099>关于权限的大问题</FONT>：由于我们常常提倡『不要以 root 来启动 daemon 』，所以这个 squid 我们是以 nobody 与 nogroup 来启动的！而 Process 与权限的关系是相当相当的重要的，因此，您必需要将上面刚刚建立的 cache_dir 更动整个目录的拥有者才行！如果是锻炼功力而已，那么随意建立一个目录更动一下他的拥有者与群组，就行了，不然的话，请依照您的硬盘规划好好的设计一番！ </LI></UL>　 
<UL>
<LI><FONT color=#000099>关于 cache_dir 重新建置的步骤</FONT>：在上面的第 7 个步骤当中，我们必需以 squid -z 来重建一下 cache_dir 的格式，这个步骤在第一次启动 squid 时才做，其它时候就不需要进行了！而进行这个步骤之前，请务必将上面提到的两点注意事项先搞定，否则您的 squid 很难启动喔！ <BR>　 
<LI><FONT color=#000099>实际浏览器的查验</FONT>：虽然上面第 8 个步骤已经确认了 squid 启动了，但是还不能肯定工作正常，这个时候如果您有 client 端的计算机，假设是 Windows 的 IE 好了，那么就赶紧来测试看看能不能使用 squid ！启动 IE 后，按下： 
<UL><FONT color=#000066>『工具』-&gt;</FONT> <BR><FONT color=#000066>『Internet 选项』-&gt;</FONT> <BR><FONT color=#000066>『联机』-&gt;</FONT> <BR><FONT color=#000066>『局域网络设定』中，点选</FONT> <BR><FONT color=#000066>『使用 Proxy 服务器』</FONT></UL>并在网址列输入你的主机名称 ( 或者是 IP 均可 )，然后按确定离开！然后在 IE 中按按看网页的设定有没有成功，如果可以读到网页的话，表示 squid 可以正常的被使用了！ <BR>　 
<LI><FONT color=#000099>cache_dir 这个参数的意义与存取格式的类型</FONT>： <BR>这个设定项目就是限制暂存区大小的地方啦，格式为： <BR>　 
<UL><FONT face=SimSun color=#000066>cache_dir ufs /usr/local/squid/var/cache 100 16 256</FONT></UL>　 <BR>上面的说明是：暂存区目录为 /usr/local/squid/var/cache ，而暂存空间大小为 100M ， 在这个暂存目录下有 16 个目录，而每个目录中又有 256 个目录 ( 你可以实际进入 /usr/local/squid/cache 当中去看看 ) 。如果你要改变暂存盘目录及这个目录的大小时，可以在这里修改！不建议修改 16, 256 这两个数值。另外，通常，如果是我们一般小型的区网 ( 不超过10个人 ) ，那设定个&nbsp; 500 MB作为 cache 应该够了，如果你的硬盘够大，设定成 1000 MB 以上更好，当然，与第一个注意事项相符的，需要与您的实际硬盘大小以及 Partition 放置的目录互相配合才行。修改过这个指令后，要再重新启动 squid 之前，请先使用下面的指令来使你的目录可以进行存取的动作，否则你的 squid 是不会工作的！例如你将上面的参数修改成： <BR>　 
<UL><FONT face=SimSun color=#000066>cache_dir ufs /usr/local/squid/var/cache 1000 16 256</FONT></UL>　 <BR>然后再进行下面的指令： <BR>　 
<UL><FONT face=SimSun color=#000066>rm -rf /usr/local/squid/var/cache</FONT> <BR><FONT face=SimSun color=#000066>mkdir /usr/local/squid/var/cache</FONT> <BR><FONT face=SimSun color=#000066>chown nobody:nogroup /usr/local/squid/var/cache</FONT> <BR><FONT face=SimSun color=#000066>/usr/local/squid/sbin/squid -z</FONT></UL><FONT color=#000000>　</FONT> <BR><FONT color=#000000>这样你的squid暂存目录就可以使用！另外，如果你在编译 (configure 过程中) 的时候有将 --enable-async-io 这一个参数加进来的话，将可以增加 </FONT><B><FONT color=#000066>aufs</FONT></B><FONT color=#000000> 这一个数据存取的格式！这个存取的格式可以将你的硬盘发挥到最极限的速度喔！虽然在 squid.conf 档案中有提及，这个 type 可能会有 bug 存在，不过，据鸟哥的使用结果，发现，没啥大问题！好用的很！所以，你可以将上面的咚咚改成下面的样子：</FONT> 
<UL><FONT face=SimSun color=#000066>cache_dir aufs /usr/local/squid/var/cache 1000 16 256</FONT></UL></LI></UL>　 <BR>这样就算已经完成了一个『很阳春』的小型 proxy 了！为什么说很阳春呢？这是因为这个 Proxy 并没有上层 Proxy 喂数据，所以 Client 端的任何要求这个 Proxy 都需要『自己去捉』啊！哇！那么这个 Proxy 还真累啊！没错啊，所以底下我们要再来谈一谈其它几个增加 proxy 效能的方法，好让大家的 Proxy Server 可以真的加快您浏览的速度啊！ <BR>　 <BR>
<HR width="100%">
<A name=server_mem_cache></A><FONT color=#000099 size=+1>内存与磁盘快取留存百分比设定</FONT> <BR>　 <BR>内存与磁盘快取在 squid.conf 当中的相关简易设定如下所示，至于更详细的说明则在下表之后进行解说： <BR>　 
<TABLE cols=1 width=550 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun color=#ffffcc size=-1># 与内存有关的设定：因为我的系统很小，所以只给 8 MB！如果您的物理内存</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 很大的情况下，例如 512 MB，可以考虑加大到 64 或 128 MB。</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_mem&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 8 MB</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 与磁盘容量有关的设定(注：下列的 90 与 95 是百分比 )</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 如果您的 cache_dir 所在磁盘很大时，可以考虑将 4096 改成 32768 KB</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_swap_low&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 90</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_swap_high&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 95</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>maximum_object_size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4096 KB</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 与内存保存数据有关的设定</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>maximum_object_size_in_memory&nbsp;&nbsp; 8 KB</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 我们经由 dns 正反解以及 IP 的结果，记录在暂存区啊！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>ipcache_size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1024</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>ipcache_low&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 90</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>ipcache_high&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 95</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>fqdncache_size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1024</FONT></TD></TR></TBODY></TABLE>　 <BR><B><FONT color=#000099>内存的需求数量：</FONT></B> <BR>事实上，除了硬盘之外，内存可能是另一个相当重要的影响 Proxy 效能的因子！怎么说呢？因为 Proxy 会将数据存一份在 Cache 硬盘中，但是同时也会将数据暂存在内存当中啊，以加快未来使用者存取同一份数据的速度！所以，内存本来就会被 squid 的程序所消耗掉一些！一般来说，被 squid 消耗掉的内存约略每 1GBytes 的 cache_dir 空间就消耗 10MB 的内存容量，所以，如果以上面我们的设定为例 (cache1, cache2 共有 3GB)， 那么就有 30MB 以上的内存被消耗掉了！除此之外， squid 程序执行当中亦会额外的消耗掉一些物理内存，这部份占用掉的内存约为 10-20 MB 。 <BR>　 <BR>除了这些内存是必须要的之外，您还可以额外的指定一些内存来进行比较『热门』的数据存取！也就是说，可以额外的再加一些内存来帮助 squid 工作，而不仅只是上面提到的内存使用量！那个就是 cache_mem 这个设定参数的用途啦！所以，请特别留意啊，『 <FONT color=#000066>cache_mem 并不是指我要使用多少内存给 squid 使用，而是指 "我还要额外提供多少内存给 squid 使用" 的意思</FONT>』！因此，假设我有 X GB 的磁盘快取空间，而且 squid 程序使用掉 15 MB 的内存，那么我 squid 使用掉的内存就有： <BR>　 
<UL><FONT color=#000066>X * 10 + 15 + "cache_mem 设定值"</FONT></UL>　 <BR>您可以自行计算一下您的 squid 消耗掉多少内存喔！此外， squid 官方网站建议您的物理内存 (不含 swap 的内存容量) 最好是上面数值的两倍，也就是说，假如我的快取容量为 3 GB ， cache_mem 设定为 16MB ，那么我的 squid 至少会消耗掉 3*10+15+16 = 61MB，则我的物理内存最好至少要有 122 MB 以上，才会有比较好的效能！当然，这个单指 Proxy 部分而已，如果您的该部主机还有负责其它的工作，呵呵！那么内存就得在累加上去啦！一般来说，如果您的 Proxy 很多人使用时，这个值越大越好，但是最好也要符合上面的需求喔！ <BR>　 <BR><B><FONT color=#000099>关于磁盘容量的设定</FONT></B>： <BR>请注意，如果您的磁盘快取空间额满了，那么您的 squid 也就『挂点』了！因此，请随时注意你的磁盘快取空间！但是，要我天天去注意 squid 的 cache_dir 里面的容量，也太劳神了吧？！这个时候就必须要『cache_swap_low, cache_swap_high 』这些设定的帮忙了！如果以上面表格的设定为例时，他的说明是『<FONT color=#000066>当我的快取目录所占容量为总快取量的 95% 时，那么我的 squid 将会自动的将快取目录内的容量减低至剩下 90% 的容量！</FONT>』注意，那个 90 与 95 为百分比例喔！以我们的设定为例，我的 cache_dir 总共有 3GB ，那么当快取空间被使用了 3*0.95=2.85GB 时，我的 squid 会自动的将 2.85GB 里面较旧的数据删除，使快取目录内剩下 3*0.9=2.7GB 的空间！这样能了解了吧？请特别注意，如果您的 proxy 容易很多人同时上线时，请将这两个数值更动一下，例如变更为 70 85 ，为什么呢？万一您的使用者突然间都上线了，然后下载大量的档案，那么『瞬间』可能会使您的 cache 目录超过额度，导致 cache 死掉！所以降低 cache_swap_high 对于大型 proxy 是有需要的！ <BR>　 <BR><B><FONT color=#000099>是否需要记录捉到的数据</FONT></B>： <BR>还有一个小问题要说明的，是否使用者要求过的数据我都要记录呢？呵呵！那当然不是啦！如果都记录的话，万一像最近好多 Linux distribution 都释出了他们新版的 Linux ISO 档案，那些档案一个都有 600 MB 以上的容量，万一使用者下载个几个这样的档案，我们的 Proxy 想不爆掉都很难～所以这个时候就要限制一下需要记录的『最大档案』啦！在预设的情况下，我们的 squid 对于超过 4MB 的档案是不记录的(就是不放入 cache 的意思)，但是如果您的硬盘够大的话，我都喜欢将这个数值调大一点，为什么呢？万一我的使用者常常下载一些 10~20 MB 的套件档案，难道我每次都要到官方网站去下载一次吗？当然我不想这样啊！所以我通常将这个数值调大到 32MB ，或者是 32768 KB ！除了磁盘快取之外，内存的快取可以记录的最大档案容量也可以修正一下喔！但是我们的内存可就珍贵的多了！不要开太大，大约默认值就很不错了！ <BR>　 <BR><B><FONT color=#000099>关于 IP 与完整主机名称的纪录</FONT></B>： <BR>如果能将 IP 与主机名称记录下来的话，搜寻的脚步也会加快一些的！所以以上面的表格为例，我们分别开启了 ipcache_size 与 fqdncache_size( 后面接的数值是 bytes )的记忆容量，由于这些数据都是 ASCII 的数据，用不了什么空间，因此 1024 bytes 已经足够了！至于后面的 low 与 high 则与前面说明的相同！ <BR>　 <BR>
<HR width="100%">
<A name=server_acl></A><FONT color=#000099 size=+1>acl 的用法与用途</FONT> <BR>　 <BR>在 squid.conf 这个档案里面最常看到的大概就是 acl 这个设定项目了！他可是整个 squid.conf 的重头戏啊！很多的来源与目的管制都是靠他来设定完成的呢！我们底下就稍微谈一谈这个重要的咚咚吧！首先，他的语法为： <BR>　 
<TABLE cols=1 width=550 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun color=#ffffcc size=-1>&lt;acl&gt; &lt;acl名称&gt; &lt;acl类型&gt; &lt;设定的内容&gt;</FONT></TD></TR></TBODY></TABLE>　 <BR>上面那个 &lt;acl名称&gt; 可以想成是一个昵称就是了！别想太多～就只是一个代名词，至于 acl 类型可就有趣的多了，他主要有下面这几大类： <BR>　 <BR><B><FONT color=#000099>以来源端来控制：</FONT></B> 
<UL>
<LI><B><FONT color=#000066>src　 ip-address/netmask</FONT></B>：主要控制『<FONT color=#000066>来源的 IP 地址</FONT>』，例如『<FONT face=SimSun color=#000066>acl nckuip src 140.116.0.0/16</FONT>』，这表示未来在 squid.conf 里面，任何使用到 nckuip 这个代名词时，就表示他是『来源为 140.116.0.0/16 的地址』！ 
<LI><B><FONT color=#000066>src　addr1-addr2/netmask</FONT></B>：主要控制『<FONT color=#000066>一段范围来源的 IP 地址</FONT>』，例如『<FONT face=SimSun color=#000066>acl nckuevoffice src 140.116.44.120-140.116.44.130/24</FONT>』就表示 nckuevoffice 这个代名词为来自 140.116.44.120 到 140.116.44.130 之间这 11 个 IP 的要求！』请注意，是『来源』喔！ 
<LI><B><FONT color=#000066>srcdomain　.foo.com</FONT></B>：主要控制『<FONT color=#000066>来源为一某个网域的计算机</FONT>』的意思，例如：『<FONT face=SimSun color=#000066>acl vbirdhome srcdomain .vbird.org</FONT>』，与 src 很类似，都是控制来源的客户端，只不过 src 控制的是 IP 而 srcdomain 则是控制 domain name 就是了！ </LI></UL>　 <BR><B><FONT color=#000099>以目的端来控制：</FONT></B> 
<UL>
<LI><B><FONT color=#000066>dst　ip-address/netmask</FONT></B>：主要控制『目的端的 IP 地址』，与 src 类似，只不过是用来控制『目的端』的地址！ 
<LI><B><FONT color=#000066>dstdomain　.foo.com</FONT></B>：这个就没问题了吧？就是用来控制『目的端的网域』！与 srcdomain 类似喔！ </LI></UL>　 <BR><B><FONT color=#000099>以正规表示法的方式来控制</FONT></B>： 
<UL>
<LI><B><FONT face=SimSun color=#000066>url_regex [-i] ^http:// </FONT></B>：除了上面两种基本的方法之外，我们也可以使用<B><FONT color=#000066>正规表示法</FONT></B>的方式来控制『网域』的设定值呢！例如『<FONT face=SimSun color=#000066> acl urlname url_regex ^http://linux\.vbird\.org.*</FONT> 』这表示 urlname 代表的就是来自 http://linux.vbird.org 这个网站的『任何资料』，因为『 .* 』代表任意字符的意思啊！如果仅只是一些档名，例如 gif 这一类的档名时，要怎么作呢？就如底下的说明啦！ 
<LI><B><FONT face=SimSun color=#000066>urlpath_regex [-i] \.gif$</FONT></B>：上面提到的是关于整个网址的名称，这里则是只要『URL 部分相同』就可以啦！例如『<FONT face=SimSun color=#000066>acl gifname urlpath_regex \.gif$ </FONT>』则是代表 gifname 代表的是 url 后面是 .gif 的网址，呵呵！那就是 gif 的图档附档名嘛！！这样应该不难理解了吧！ </LI></UL>　 <BR>由于在 squid 当中很多时候都会用到一些 IP 网域啦，以及 domain name 等等的数据，这个时候这个 acl 就可以看做与 bash 里面的『变量』很类似！您可以参考看看的啦！只是他的用途相当的广泛，这个在底下我们会进一步的使用 acl 搭配各种设定值来进行说明的！ <BR>　 <BR>
<HR width="100%">
<A name=server_upper_proxy></A><FONT color=#000099 size=+1>上层 Proxy 的选择与负载分流的设定方法</FONT> <BR><FONT color=#000000>　</FONT> <BR><B><FONT color=#000099>上层 Proxy 的设定方式： cache_peer</FONT></B> <BR>我们在上面的原理部分说明过，一部有效能的 Proxy server 必须要能利用上层 Proxy 所提供的效能，才能达到我们所想要的『加速』功能！那么当然大前提之下就是需要先找到『最佳效能的上层 Proxy 主机』！没错！就是这样的啦！在这里，我们以成功大学的学术网络为架构进行说明，如果您的网络架构并非为学术单位的话，请依照您能找到的上层 Proxy 来进行设定喔！需要特别留意的是，由于成大有许多的上层代理服务器，这些服务器都可以做为我个人 proxy 的 parent proxy 主机，不过，由于各个主要的 parent proxy 所提供的网域服务都不尽相同，所以我们得先将主要的几个服务器对应的网域给他找出来，底下是一个例子： <BR>　 <BR><FONT face=SimSun color=#000066>gate.ncku.edu.tw&nbsp; 主要服务 .com 的网域</FONT> <BR><FONT face=SimSun color=#000066>gate3.ncku.edu.tw 主要服务 .net .edu 的网域</FONT> <BR><FONT face=SimSun color=#000066>gate2.ncku.edu.tw 主要服务非 .com .net 与 .edu 的网域</FONT> <BR><FONT face=SimSun color=#000066>proxy.ncku.edu.tw 主要服务任何网址</FONT> <BR>　 <BR>至于在 squid.conf 当中设定的参数则是『cache_peer 』这个项目，设定的样式为： <BR>　 
<TABLE cols=1 width=550 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun color=#ffff00 size=-1>&lt;cache_peer&gt; &lt;主机名称&gt; &lt;类别&gt; &lt;http_port&gt; &lt;icp_port&gt; &lt;其它参数&gt;</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>类别：主要有上层(parent) 与同一层 (sibling) 两种，我们这里主要介绍的是</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>　　　上层 Proxy 也就是 parent 这一大类，如果您想要架设一个小型的 Proxy</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>　　　Cluster 的话，可以考虑组成 sibling 的功能，由于我们仅想要架设单部</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>　　　Proxy Server ，所以这里我们就不探讨 sibling 了！</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffcc>http_port icp_port</FONT><FONT color=#ff6666>：就是我们最前面设定的啦！ Internet 上面预设是</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>　　　3128 3130 这两个！</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>其它参数：其它参数的部分就很重要了，主要有底下几个重要参数：</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ff6666>　　</FONT><FONT color=#ffffcc>proxy-only</FONT><FONT color=#ff6666> ：只取出上层 Proxy 的 cache 给 client ，并不会将上层 Proxy</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>　　　　的数据存在自己的 cache 硬盘中；</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ff6666>　</FONT><FONT color=#ffffcc>　weight=n</FONT><FONT color=#ff6666>　：权重的意思，因为我们可以指定多部上层 Proxy 主机，哪一部</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>　　　　最重要？就可以利用这个 weight 来设定， n 越大表示这部 Proxy</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>　　　　越重要！</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffcc>　　no-query</FONT><FONT color=#ff6666>　：一般来说，如果要向 sibling 要求数据时，会向 sibling 送出</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>　　　　icp 的要求封包，使用 no-query 就可以取消。一般来说，如果向上层</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>　　　　Proxy 要求资料时，可以不需要发送 icp 封包，以降低主机的负担</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ff6666>　　</FONT><FONT color=#ffffcc>default</FONT><FONT color=#ff6666>　　：表示该部主机为预设的 Proxy 主机的意思；</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ff6666>　　</FONT><FONT color=#ffffcc>no-netdb-exchange</FONT><FONT color=#ff6666>：表示不向附近的 Proxy 主机送出 imcp 的封包要求</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ff6666>　</FONT><FONT color=#ffffcc>　no-digest</FONT><FONT color=#ff6666>　：表示不向附近主机要求建立 digest 纪录表格。</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>范例：</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer gate.ncku.edu.tw parent 3128 3130 no-digest no-netdb-exchange</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer gate2.ncku.edu.tw parent 3128 3130 no-digest no-netdb-exchange</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer gate3.ncku.edu.tw parent 3128 3130 no-digest no-netdb-exchange</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer proxy.ncku.edu.tw parent 3128 3130 no-digest no-netdb-exchange</FONT></TD></TR></TBODY></TABLE>　 <BR>基本上，由于我们向上层 Proxy 要求数据的时候，也是需要时间的，因此，这里我们建议您不要设定太多的上层 proxy 主机，一般来说， 2~4 部也就足够了，太多部 上层Proxy 的情况反而可能会拖垮您的 Proxy 速度呢！OK！既然有了上层 Proxy ，而且每一部所负责的网域并不相同，所以我们当然就需要将网域分门别类！如何将这些网域分门别类呢？那就需要 acl 的帮忙啦！先提醒一下，由于我们的 Proxy 旨在帮助 client 端取得数据，所以使用 acl 的时候，是针对『目标』来进行设定的，因此，使用的是 dst 与 dstdomain 喔！在这里，我们将主要的网域分成底下这几大类： <BR>　 
<TABLE cols=1 width=550 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun color=#ffffcc size=-1>0. 自己想要直接使用自己的 Proxy 捉取的资料</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>acl directip dst 140.116.44.0/24</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>acl directdn dstdomain .vbird.org tw.yaoo.com tw.news.yahoo.com</FONT> 
<P><FONT face=SimSun color=#ffffcc size=-1>1. 成大附近的网域</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>acl nckudn dstdomain .ncku.edu.tw</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>acl nckuip dst 140.116.0.0/16 163.28.112.0/24 163.28.113.0/24 163.28.114.0/24 163.28.115.0/24 163.28.116.0/24 163.28.117.0/24</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>2. 台湾的网域 (请注意：底下为同一行)</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>acl twdn dstdomain .tw .twnic.net .hinet.net .acer.net .wownet.net .seeder.net .silkera.net .neto.net timenet.net tw.aunet.net .adsldns.org&nbsp;</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>3. 台湾的 IP (注意：底下为同一行)</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>acl twip dst 163.28.0.0/16 140.96.0.0/11 140.128.0.0/12 140.92.0.0/16 139.175.0.0/16 139.223.0.0/16 163.12.0.0/14 163.16.0.0/14 168.95.0.0/16 192.72.0.0/16 192.83.160.0/19 192.83.192.0/22 192.192.0.0/16 202.39.0.0/16 202.132.128.0/17 202.145.224.0/19 203.64.0.0/12 210.64.0.0/13 210.60.0.0/14</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>4. 一些商业、网域、教育、以及其它的网域</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>acl comdn dstdomain .com</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>acl netdn dstdomain .net</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>acl edudn dstdomain .edu</FONT></P></TD></TR></TBODY></TABLE>　 <BR>这样子就作好了基础的工作了！接着下来，我们要开始来设定『各个主要的网域要透过哪一个上层 Proxy 来进行数据的取得？』这里就有点难度啦！得小心在意一下！我们的基本假设为这样： <BR><FONT face=SimSun color=#000066>gate.ncku.edu.tw&nbsp; 仅负责 .com 的网域；</FONT> <BR><FONT face=SimSun color=#000066>gate3.ncku.edu.tw 仅负责 .net 与 .edu 的网域</FONT> <BR><FONT face=SimSun color=#000066>gate2.ncku.edu.tw 不负责上面的三个网域</FONT> <BR><FONT face=SimSun color=#000066>proxy.ncku.edu.tw 不负责上面三个网域</FONT> <BR>这么一来，使用 cache_peer_access 这个设定项目时，我们的设定会变成这样喔！ <BR>　 
<TABLE cols=1 width=550 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun color=#ffffcc size=-1># 主要的格式范例：</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># &lt;cache_peer_access&gt; &lt;上层 Proxy &gt; &lt;allow|deny&gt; &lt;acl名称&gt;</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access gate.ncku.edu.tw&nbsp; allow comdn</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access gate.ncku.edu.tw&nbsp; deny&nbsp; !comdn</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access gate3.ncku.edu.tw allow netdn</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access gate3.ncku.edu.tw allow edudn</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access gate3.ncku.edu.tw deny&nbsp; !netdn</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access gate3.ncku.edu.tw deny&nbsp; !edudn</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access gate2.ncku.edu.tw deny&nbsp; comdn</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access gate2.ncku.edu.tw deny&nbsp; netdn</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access gate2.ncku.edu.tw deny&nbsp; edudn</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access gate2.ncku.edu.tw deny&nbsp; directdn</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access gate2.ncku.edu.tw deny&nbsp; directip</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access gate2.ncku.edu.tw deny&nbsp; twdn</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access gate2.ncku.edu.tw deny&nbsp; twip</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access gate2.ncku.edu.tw deny&nbsp; nckudn</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access gate2.ncku.edu.tw deny&nbsp; nckuip</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access proxy.ncku.edu.tw deny&nbsp; comdn</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access proxy.ncku.edu.tw deny&nbsp; netdn</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access proxy.ncku.edu.tw deny&nbsp; edudn</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access proxy.ncku.edu.tw deny&nbsp; directdn</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access proxy.ncku.edu.tw deny&nbsp; directip</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access proxy.ncku.edu.tw deny&nbsp; twdn</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access proxy.ncku.edu.tw deny&nbsp; twip</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access proxy.ncku.edu.tw deny&nbsp; nckudn</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>cache_peer_access proxy.ncku.edu.tw deny&nbsp; nckuip</FONT></TD></TR></TBODY></TABLE>　 <BR>经过上面这个动作，我们就可以将 .com 的要求经过 gate.ncku.edu.tw 这一部，并且将 .net 与 .edu 给 gate3.ncku.edu.tw 来服务！此外，将没有被自己定义出来的 IP 或者是网域就丢给 gate2 以及 proxy 这两部来服务，至于我们既然是在台湾，所以自己定义出来的四个 acl 名字 (directdn, directip, twdn, twip) 当然是直接交给我们自己的 Proxy 来捉取了，相信速度上面应该不会有任何的影响的！因此，那四个主要的 acl 名称将在后面继续介绍如何不要透过上层 Proxy 来捉取资料喔！ ( 请参考 always_direct 与 never_direct 的设定值 ) <BR>　 <BR><B><FONT color=#000099>不要进行 cache 的设定值：</FONT></B> <BR>就如同我们在原理的部分提到的，有些网站的资料事实上并没有做为 cache 的需要，例如 CGI 档案就是一个很鲜明的案例！所以，一般而言， squid 在一开始就会自动帮我们设定好底下这三行： <BR>　 
<TABLE cols=1 width=550 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun color=#ffff00 size=-1>hierarchy_stoplist&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cgi-bin ?</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>acl QUERY urlpath_regex cgi-bin \?</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>no_cache deny QUERY</FONT></TD></TR></TBODY></TABLE>　 <BR>上面这三行的意思是：『<FONT color=#000066>只要在网址列出现了 cgi-bin 的字样时，该网页数据就不进行 cache 的动作</FONT>！』这样一来，可以避免我们的主机存放太多的垃圾啊！ ^_^！当然啦，在某些时候，例如您所在的网域真的是很慢，同时又没有适合的上层 Proxy 的环境下，那么将 cgi 之类的网页 cache 下来，也未尝不是一个可以节省浏览时间的一个方法！如果确定要将 cgi-bin 底下的网页也存下来的话，那么就将上面三行批注掉！ <BR>　 <BR>
<HR width="100%">
<A name=server_time_par></A><FONT color=#000099 size=+1>与时间相关的设定值 ( connect_timeout, request_timeout )</FONT> <BR>　 <BR>由于 Proxy 的设定除了防火墙的额外功能外，最主要的目的还是在于将网页数据 cache 下来！既然如此的话，那么与 Server 的联机时间的确认就显的很重要啦！怎么说呢？万一今天您有设定三部上层 Proxy ，每一部的要求时间都控制在 5 分钟，如此一来，呵呵！万一今天刚好三部上层 Proxy 都挂点，难道我们就宿命似的要等待 15 分钟吗？当然不是啦！所以这个时候，我们可以将联机的等待时间缩短，好让 Proxy 可以发挥更为强大的功能啊！ <BR>　 
<TABLE cols=1 width=550 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun color=#ffffcc size=-1># 1. 关于 cache 的更新时间趋势</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 我们在快取当中的数据总是需要更新的对吧！那么如何设定更新的时间呢？</FONT> <BR><FONT face=SimSun color=#ffff99 size=-1># &lt;refresh_pattern&gt; &lt;regex&gt; &lt;最小时间&gt; &lt;百分比&gt; &lt;最大时间&gt;</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 注意，那个 regex 指的是『目标』，这个『目标』大部分为网址，而这个网址</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 使用正规表示法来表示就是了！上面的意义是说：最小的时间内 (分钟)，如果</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 档案有更动，就直接更新，或者是目标档案上次更新的时间到现在已经经过最大</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 时间的『百分比』时，就予以更新！范例如下：</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>refresh_pattern ^ftp:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1440&nbsp;&nbsp;&nbsp; 20%&nbsp;&nbsp;&nbsp;&nbsp; 10080</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>refresh_pattern ^gopher:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1440&nbsp;&nbsp;&nbsp; 0%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1440</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>refresh_pattern .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 20%&nbsp;&nbsp;&nbsp;&nbsp; 4320</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 第一行的意思是，如果网址裂开头是 ftp 的话，那么在一天(1440分钟)后，如果</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># proxy 再次取用这个档案时，则 cache 内的数据会被更新！</FONT> 
<P><FONT face=SimSun color=#ffffcc size=-1># 2. 关于联机时间限制</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ff6666># </FONT><FONT color=#ffff99>connect_timeout</FONT><FONT color=#ff6666> 指的是连接到其它主机的时间多久之后算失败，预设是两分钟</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　　　　　　　不过我觉得我的机器联机速度还算快速，所以减低了时间</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ff6666># </FONT><FONT color=#ffff99>peer_connect_timeout</FONT><FONT color=#ff6666> 指的是连接到上层 Proxy 多久不成功就算失败，</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　　　　　　　由于上层 Proxy 与我的环境息息相关，不可能连不上，</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>#　　　　　　　　所以我这里将时间调整的很短！</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ff6666># </FONT><FONT color=#ffff99>request_timeout</FONT><FONT color=#ff6666> 指的是，联机上了，但是要求的时间会多长？</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ff6666># </FONT><FONT color=#ffff99>persistent_request_timeout</FONT><FONT color=#ff6666> 指的是连续要求时间会有多长？</FONT></FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>connect_timeout 30 seconds</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>peer_connect_timeout 10 seconds</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>request_timeout 1 minutes</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>persistent_request_timeout 20 seconds</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 请特别注意喔！上面的设定当中，是因为我的环境『还算不错』，所以我将</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 时间调整的很短，因为我晓得我的环境当中不会有花很长时间的状况，</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 这里请依照您的网络环境来调整喔！或者干脆不要设定也没有关系！</FONT></P></TD></TR></TBODY></TABLE>　 <BR>
<HR width="100%">
<A name=server_always_direct></A><FONT color=#000099 size=+1>总是系统自己来捉数据(always_direct)</FONT> <BR>　 <BR>刚刚我们在主机分流的地方有提过，有些数据我们要让我们自己的 Proxy 去捉取数据即可，而不透过上层 Proxy ，那么怎么达到这样的目的呢？也不是很难啦！就告诉 Proxy 不要去捉就好啦！怎么告诉他呢？使用 always_direct 或 never_direct 即可！ <BR>　 
<TABLE cols=1 width=550 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun color=#ffffcc size=-1># 1. 使用 acl 先定义出要直接或者不要直接去的网址或 IP ，</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 　 这个部分我们刚刚在上面已经设定好了，就是 directip 与 directdn，</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>#　　还有 twdn 与 twip 这几个咚咚！</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 2. 如果是直接要 Proxy 出去捉数据，可以使用 always_direct</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>always_direct allow directip directdn</FONT> 
<P><FONT face=SimSun color=#ffffcc size=-1># 3. 如果一定『拒绝经由上层 Proxy 出去』的话，可以使用 never_direct&nbsp;</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>never_direct deny twdn twip</FONT> </P>
<P><FONT face=SimSun color=#ffffcc size=-1># never_direct allow 表示一定会经由上层 Proxy 来捉资料，</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># never_direct deny&nbsp; 当然就表示一定是自己向外头捉资料！</FONT></P></TD></TR></TBODY></TABLE>　 <BR>事实上，这个东西可以让我们的 Proxy 变的很灵活！假设这样的一个案例，我们自己有一个内部的 WWW 网站，这个网站的网址为 192.168.0.100 ，如果我要经由上层 Proxy 去捉数据的话，那不就完蛋了～因为这个是『私有 IP 』的网域啊！所以，我将他写入 directip 那个 acl 的设定当中，如此一来，呵呵！我们的 Proxy 会自动的经由自己的 route table 去到内部网域读取数据给你，您根本不需要变更您的其它设定就可以自由自在的读取内部与外部的主机数据！此外，如果您发现同一网域还有其它的 WWW 主机，把这些主机的 IP 或主机名称写入 directdn 或 directip 的 acl 设定当中吧！因为在同一网域时，您自己去捉一定会比上层 proxy 捉完之后再传给你来的快吧！ <BR>　 <BR>当然还不只如此啦，有的 WWW主机由于设定的关系，他们并不允许我们的上层 Proxy 来捉取数据，最常见的例子就是类似总图对校内的 client 端开放的图书查寻的软件了！因为如果开放了这些上层 proxy 的话，那么全台湾所有的人只要将他们的浏览器 proxy 设定为成大的上层 proxy 主机，就可以使用成大的资源了！那岂不麻烦？因为这些资源是需要花费经费的啊！这个时候，您也就必须要让这些网址经由我们的 Proxy 自己去捉取！这样可以了解乎！ <BR>　 <BR>
<HR width="100%">
<A name=server_access_control></A><FONT color=#000099 size=+1>限制使用 proxy 使用者与 proxy 目标的方式 (acl and http_access )</FONT> <BR>　 <BR>既然 proxy 有一定的风险存在，自然就不能让任何人都能使用你的 proxy 主机！没错！所以我们必须要管制联机的使用者！管制的方法真是简单的很！就是使用 acl 配合 http_access 即可！在预设的情况中， squid 已经帮我们设定好一些安全的可以联机的 port 了，此外，也只有本机可以使用 proxy 功能呢！ <BR>　 <BR>那么万一如果我样让内部 192.168.0.0/24 这个网域的使用者可以使用我的 proxy 呢？该如何设定？呵呵！您可以这样做： <BR>　 
<TABLE cols=1 width=550 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun color=#ffffcc size=-1># 1. 先设定这个内部网域的 acl 名称</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>acl inside src 192.168.0.0/24</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 2. 设定 http_access 让他可以使用</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>http_access allow inside</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>http_access deny&nbsp; all</FONT></TD></TR></TBODY></TABLE>　 <BR>那个 http_access deny all 是系统预设的项目！刚刚我们在 <A href="#server_basic">最简单的 squid.conf 设定</A> 时已经将他改成 http_access allow all 了！所以请记得将他给改回来啊！不然的话，您的 Proxy 很有可能会被人家利用喔！ <BR>　 <BR>这里再提供一个值得思考的咚咚，如果您跟我一样，都是使用拨接的 ADSL ，这样一来，由于我们的 IP 都不是固定的，如果要让我们的 ADSL 拨接的 client 可以使用我们刚刚设定的 Proxy 时，该怎么办？啊！这样就不能使用『 acl 配合 src 』的设定方式了吗？呵呵！当然不是，您可以这样想象： <BR>　 
<OL>
<LI><FONT color=#000066>我先申请一个动态 DNS 的网域名称，例如我的 tsai.adsldns.org ；</FONT> 
<LI><FONT color=#000066>虽然我可以直接在 squid.conf 当中设定 acl 并使用 srcdomain 来设定我的 tsai.adsldns.org ，但是很抱歉的是，如果我的 tsai.adsldns.org 来连接到 Proxy 主机时，事实上，我的拨接制 IP 反查得到的主机名称一定不是 tsai.adsldns.org ，如此一来则 srcdomain 一点用处也没有了；</FONT> 
<LI><FONT color=#000066>再换个方式，如果我写一支 script 来侦测 tsai.adsldns.org 所对应的 IP 呢？并且将他写入一个自订的设定档当中，这样一来，这个档案会随时记录最新的 tsai.adsldns.org 的 IP ，如此一来，我就可以使用 acl 配合 src 的设定方式了！</FONT> </LI></OL>　 <BR>很麻烦吗？一点也不会，整个 script 可以像底下这样： <BR>　 
<TABLE cols=1 width=550 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]#</FONT><FONT color=#ffff00> cd /usr/local/squid/etc</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test etc]#</FONT><FONT color=#ffff00> vi squid.allow.sh</FONT></FONT> <BR><FONT face=SimSun color=#ffffff size=-1>#!/bin/bash</FONT> <BR><FONT face=SimSun color=#ffffff size=-1># 这支程序可以用来查寻您的 IP 喔！</FONT> 
<P><FONT face=SimSun color=#ffffff size=-1># 1. 请输入您的主机名称，请注意，如果有两个以上的主机名称，</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>#&nbsp;&nbsp;&nbsp; 请分别以空格分开各个主机名称</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>hostnames='</FONT><B><FONT color=#ffff00>tsai.adsldns.org test.adsldns.org</FONT></B><FONT color=#ffffff>'</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>basedir=</FONT><B><FONT color=#ffff00>/usr/local/squid/etc/</FONT></B></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>email=</FONT><B><FONT color=#ffff00>root@localhost</FONT></B></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>squid=</FONT><B><FONT color=#ffff00>/usr/local/squid/sbin/squid</FONT></B></FONT> </P>
<P><FONT face=SimSun color=#ffffff size=-1># 2. 以下为程序段，看看就好了！</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>[ -f $basedir/squid.allow.hosts.raw ] || \</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; touch $basedir/squid.allow.hosts.raw</FONT> </P>
<P><FONT face=SimSun color=#ffffff size=-1>cat /dev/null &gt; $basedir/squid.allow.hosts.now</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>runornot=no</FONT> </P>
<P><FONT face=SimSun color=#ffffff size=-1>for host in $hostnames</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>do</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hostip=`host $host | awk '{print $4}'`</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if [ "$hostip" == "out;" ]; then</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo 'Proxy 回应：没有 DNS 的讯息！' |\</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mail -s 'Proxy 主机响应' $email</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exit</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fi</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fileraw="$basedir"/squid.allow.`echo $host|cut -d '.' -f1`</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [ -f $fileraw ] || touch $fileraw</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hostraw=`cat $fileraw`</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if [ "$hostraw" != "$hostip" ]; then</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; runornot="yes"</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo $hostip &gt; $fileraw</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fi</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo $hostip &gt;&gt; $basedir/squid.allow.hosts.now</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>done</FONT> </P>
<P><FONT face=SimSun color=#ffffff size=-1>if [ "$runornot" == "yes" ]; then</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cat $basedir/squid.allow.hosts.raw &gt;&nbsp; $basedir/squid.allow.hosts</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cat $basedir/squid.allow.hosts.now &gt;&gt; $basedir/squid.allow.hosts</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $squid -k reconfigure</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mail -s 'Proxy 主机响应！Client IP 已经改变' $email &lt; $basedir/squid.allow.hosts</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>fi</FONT></P></TD></TR></TBODY></TABLE>　 <BR>如此一来，我将可以把我的随时最新的 IP 纪录在 /usr/local/squid/etc/squid.allow.hosts 这个档案当中！那么要如何更新这个档案的内容在 squid 的设定档中呢！就这样设定即可： <BR>　 
<TABLE cols=1 width=549 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun color=#ffffcc size=-1># 1. 先设定这个档案的名称吧！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>acl allowhost src "/usr/local/squid/etc/squid.allow.hosts"</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 2. 设定 http_access 让他可以使用</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>http_access allow allowhost</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>http_access deny&nbsp; all</FONT></TD></TR></TBODY></TABLE>　 <BR>然后将上面这个 squid.allow.sh 给他丢进去 crontab 当中，我预设都是在 30 分钟跑一次！ <BR>　 
<TABLE cols=1 width=549 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun size=-1><FONT color=#ffffff>[root @test root]#</FONT><FONT color=#ffff00> vi /etc/crontab</FONT></FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>10,30 * * * * root /usr/local/squid/etc/squid.allow.sh</FONT></TD></TR></TBODY></TABLE>　 <BR>这样就完整的啦！ ^_^ <BR>　 <BR>
<HR width="100%">
<A name=server_other_functions></A><FONT color=#000099 size=+1>额外的功能参数</FONT> <BR>　 <BR>除了上面提到的这些关于网页快取的功能之外， Proxy 还可以帮我们进行 FTP 的服务取得资料喔！我们可以透过浏览器，经由 proxy 提供的 FTP 功能来登入对方主机，当然，对方主机必须要能够提供匿名登入啊！好了，我们来看看要怎样设定呢？ <BR>　 
<TABLE cols=1 width=550 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun color=#ffffcc size=-1># 与 FTP 有关的设定项目，主要是针对被动式联机方式来设定喔！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>ftp_user Squid@</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>ftp_passive on</FONT> 
<P><FONT face=SimSun color=#ffffcc size=-1># 主要与 DNS 的设定值有关，如果在高负载的 Proxy 环境下，可以考虑将</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># dns_children 提高到 20 左右，这个值最大为 32</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>dns_timeout 1 minutes</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>hosts_file /etc/hosts</FONT></P></TD></TR></TBODY></TABLE>　 <BR>还有一些额外的范例可以参考看看喔：</UL>
<BLOCKQUOTE>
<BLOCKQUOTE>鸟哥的范例：<A href="http://linux.vbird.org/linux_server/0420squid/0420squid_vbird_ex" target=_blank>http://linux.vbird.org/linux_server/0420squid/0420squid_vbird_ex</A> <BR>成大 gate.ncku.edu.tw 的 squid.conf 设定：<A href="http://turtle.ee.ncku.edu.tw/~tung/proxy/squid.conf.ncku" target=_blank>http://turtle.ee.ncku.edu.tw/~tung/proxy/squid.conf.ncku</A> <BR>电机系 turtle.ee.ncku.edu.tw 的 squid.conf 设定：<A href="http://turtle.ee.ncku.edu.tw/~tung/proxy/squid.conf.turtle" target=_blank>http://turtle.ee.ncku.edu.tw/~tung/proxy/squid.conf.turtle</A> <BR>台南学校范例 proxy.school.tn.edu.tw 的 squid.conf 设定：<A href="http://turtle.ee.ncku.edu.tw/~tung/proxy/squid.conf.school.tn" target=_blank>http://turtle.ee.ncku.edu.tw/~tung/proxy/squid.conf.school.tn</A></BLOCKQUOTE></BLOCKQUOTE>
<HR width="100%">
<A name=client></A><FONT color=#000099 size=+1>Client 端设定</FONT> 
<UL>既然 proxy 是给浏览器用的，那么自然在浏览器上面就需要设定一些参数！呵呵，没错！那么如何设定呢？由于不同的浏览器在设定 Proxy 的地方也都不同，所以底下我们介绍目前比较常见的两款浏览器，分别是 Netscape 以及 IE 的设定，至于其它的浏览器，请参考各浏览器的相关说明啊！ <BR>　 <BR>
<HR width="100%">
<A name=client_netscape></A><FONT color=#000099 size=+1>Netscape</FONT> <BR>　 <BR>Netscape 的设定并不难，只要修改一个小地方即可！ <BR>　 
<OL>
<LI>开启 Netscape 之后，启用『<FONT color=#000066>编辑</FONT>』并选择『<FONT color=#000066>偏好设定</FONT>』项目，如下所示： <BR>　 <BR><IMG height=198 src="71_files/0420squid_client_netscape_1[1].jpg" width=181 nosave=""> <BR>　 
<LI>在出现的画面当中，先按下『<FONT color=#000066>进阶</FONT>』左边的展开模式，然后选择底下的『<FONT color=#000066>代理服务器</FONT>』，则画面会出现如下的模样。之后，在右边的窗口当中选择『<FONT color=#000066>自行设定代理服务器的组态</FONT>』项目，并且再按下『<FONT color=#000066>检视</FONT>』，则到下一步去设定： <BR>　 <BR><IMG height=459 src="71_files/0420squid_client_netscape_2[1].jpg" width=545 nosave=""> <BR>　 
<LI>在出现的方框中，由于我们通常仅针对 WWW 进行快取，所以可以仅针对 HTTP 的项目进行设定！在下面的画面当中，请输入『<FONT color=#000066>Proxy 主机的 IP 或者是 domain name </FONT>』，以及『<FONT color=#000066>连接的 port number</FONT>』，这样就可以了。不过，如果有某些网域您想要直接让你的 PC 去捉取数据时，可以将该网域名称填写在最下方的方框中！以下面的画面为例，我的 PC 要连接到 linux.vbird.org 以及 www.study-area.org 时，就可以不透过 Proxy 啦！这个功能也挺适合可以自行调配流量、流速的朋友！ <BR>　 <BR><IMG height=400 src="71_files/0420squid_client_netscape_3[1].jpg" width=386 nosave=""> <BR>　 
<LI>再按下『确定』之后，立刻就生效了！ </LI></OL>　 <BR>
<HR width="100%">
<A name=client_ie></A><FONT color=#000099 size=+1>Internet Explorer</FONT> <BR>　 <BR>在 IE 的设定上面也一点都不难啊！ <BR>　 
<OL>
<LI>开启 IE ，然后在『<FONT color=#000066>工具</FONT>』内选择『<FONT color=#000066>Internet 选项</FONT>』： <BR>　 <BR><IMG height=155 src="71_files/0420squid_client_ie_1[1].jpg" width=151 nosave=""> <BR>　 
<LI>在开启的窗口内选择『<FONT color=#000066>联机</FONT>』并点选下方的『<FONT color=#000066>局域网络设定</FONT>』： <BR>　 <BR><IMG height=419 src="71_files/0420squid_client_ie_2[1].jpg" width=406 nosave=""> <BR>　 
<LI>在出现的方框中，先在下方打勾起『<FONT color=#000066>使用 Proxy 服务器</FONT>』，然后依序在网址列填入『 <FONT color=#000066>Proxy 的网址或者是 IP</FONT> 』以及连接埠填入『 <FONT color=#000066>Proxy 所开放的 port number</FONT>』，如下方的设定即可。 <BR>　 <BR><IMG height=306 src="71_files/0420squid_client_ie_3[1].jpg" width=384 nosave=""> <BR>　 
<LI>另外，如果有某些网域不想透过这个上层 Proxy 的话，点选上图的 『<FONT color=#000066>进阶</FONT>』那一项，在出现的框框的最底下，可以填入你不想透过 Proxy 捉取的网站网址，如下所示： <BR>　 <BR><IMG height=360 src="71_files/0420squid_client_ie_4[1].jpg" width=368 nosave=""> <BR>&nbsp;</LI></OL>如此一来则设定好了 Proxy Server ！</UL>
<HR width="100%">
<A name=serverahead></A><FONT color=#000099 size=+1>Server 端进阶设定</FONT> 
<UL>既然一些主机的设定已经搞定了，接着下来又是到了 Server 的安全与进阶设定时间啦！那么在安全的设定方面，最重要的自然又是我们一再强调的登录档的分析！如何分析登录档呢？难道又要自己动手写分析的 scripts ？？呵呵！不用麻烦了，我们可以使用前辈智慧的结晶，直接有软件可以来进行分析喔！还有，既然强调 Proxy 可能会被滥用，所以当然要适当的管理了！这个时候的防火墙设定又要出现啦！呵呵！赶紧来看一下怎么处理吧！ <BR>　 <BR>
<HR width="100%">
<A name=serverahead_pwebstats></A><FONT color=#000099 size=+1>末端资料分析 pwebstat</FONT> <BR>　 <BR>事实上， squid 已经有众多的登录文件分析软件了，而且大多是免费的 (<A href="http://www.squid-cache.org/Scripts/" target=_blank>http://www.squid-cache.org/Scripts/</A>) ，您可以依照自己的喜好来加以安装与分析你的 squid 喔！我这里仅介绍目前很常被使用的一套软件，也就是 <A href="http://martin.gleeson.com/pwebstats/installation.html" target=_blank>pwebstats</A> 这一套！你可以在 pwebstats 的官方网站上面查得更新的数据 ( <A href="http://martin.gleeson.com/pwebstats/installation.html" target=_blank>http://martin.gleeson.com/pwebstats/installation.html</A> )。不过，由于 pwebstats 在安装的时候需要使用到其它的函式库，因此，你必须要先安装 fly 这套软件才行啊！而在安装 fly 之前，又需要先安装一些必备的图示用的函式库才行，那就是类似 gd, libpng, zlib 等等的套件喔！听起来似乎很多东西要做，但是事实上却非常简单的啦！好吧！那么我们就一步一步的来安装这个 pwebstats 吧！ <BR>　 <BR><B><FONT color=#000099>安装所需要的套件数据：</FONT></B> <BR>除了系统自己可能已经安装好的 gd, libpng, zlib 之外，您可以由<A href="#reference">文末</A>提供的官方网站的连结来取得最新的 fly 与 pwebstats 套件，而如果您不需要使用最新的资料，那么也可以经由 <A href="http://linux.vbird.org/">鸟哥的私房菜</A> 提供的比较旧的套件版本来安装 ( <A href="http://linux.vbird.org/download/">http://linux.vbird.org/download/</A> )。我这里假设您已经将所需要的 fly-2.0.0.tar.gz 与 pwebstats-1.3.8.tar.gz 套件都下载到 /root 底下了，那么您可以这样做： 
<OL>　 
<TABLE cols=1 width=549 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun color=#ffffcc size=-1>1. 确认一下到底有没有我们需要的一些相关套件？</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]#</FONT><FONT color=#ffff00> rpm -qa | egrep '(^gd-|^zlib-|^libpng-)'</FONT></FONT> <BR><FONT face=SimSun color=#ffffff size=-1>libpng-devel-1.0.14-0.7x.4</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>gd-1.8.4-4</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>zlib-1.1.3-25.7</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>zlib-devel-1.1.3-25.7</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>libpng-1.0.14-0.7x.4</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>gd-devel-1.8.4-4</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 请注意，我是以 Red Hat 7.2 为例，如果您的系统并非 RH 7.2 ，那么可能</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 套件后面接的版本会不太一样，不过，至少都需要有上面的几样套件就是了！</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 就是 gd, zlib, libpng 这三个套件啦！有的 distribution 还会有 xxx-devel</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 之类的名称，那个也需要安装喔！如果发现没有安装的话，请拿出您的原版光盘片，</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 将他 mount 上之后，好好的将他搜寻一下，并且安装上去吧！很重要，一定要</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 安装这些套件之后，底下的动作才会成功呢！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>2. 开始安装 fly 这支程序</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]# </FONT><FONT color=#ffff00>cd /usr/local/src</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test src]# </FONT><FONT color=#ffff00>tar -zxvf /root/fly-2.0.0.tar.gz</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># ....会产生一个 fly-2.0.0 的目录</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test src]# </FONT><FONT color=#ffff00>cd fly-2.0.0</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test fly-2.0.0]# </FONT><FONT color=#ffff00>make</FONT></FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>注：</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># ....如果没有出现底下的字样那么就是成功了！</FONT> <BR><FONT face=SimSun color=#ffff99 size=-1>/usr/bin/ld: cannot find -lttf (或者是 ljpeng ...)</FONT> <BR><FONT face=SimSun color=#ffff99 size=-1>collect2: ld returned 1 exit status</FONT> <BR><FONT face=SimSun color=#ffff99 size=-1>make: *** [fly] Error 1</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 如果是出现 warning 的话，还不打紧，因为仅只是警告而已，所以问题不大，</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 但是如果出现上面的字样时，就会连带出现第三行的 Error ，那就是编译失败了</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 果真如此的话，请先寻找一下，以上面为例，找不到 lttf ，而 lttf 其实</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 就是 libttf n名啦！(所以 ljpeg 就是 libjpeg )所以给他下达：</FONT> <BR><FONT face=SimSun color=#ffff99 size=-1>loate libttf</FONT> <BR><FONT face=SimSun color=#ffff99 size=-1>/usr/lib/libttf.so.2</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 嗯！找到了！其实是 libttf.so.2 啦！如果你的系统跟我的不同，有可能档名</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 会不一样，所以请依照你的屏幕显示的讯息来下达指令喔！但是这个编译程序</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 有点笨，不认识这个档案，所以我们要欺骗他一下，就是下达：</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>ln -s /usr/lib/libttf.so.2 /usr/lib/libttf.so</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 这样就可以啦！如果还有找不到的档案，同样的方式给他连结一下即可！然后</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 再次的给他执行一次 make 即可！最后会产生一个档名为 fly 的执行档，</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 如果没有产生执行档，那就是有问题啦！请赶紧再回头去查一查是否有某些</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 套件没有安装，或者没有依照上面的方式建立连结档案！</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>　</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test fly-2.0.0]#</FONT><FONT color=#ffff00> cp fly /usr/local/bin</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>我们先将 fly 这支程序给他复制到 /usr/local/bin 这个目录去，可以直接使用</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>这样就 OK 了！</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>3. 开始安装 pwebstats 套件</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]# </FONT><FONT color=#ffff00>cd /usr/local/src</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test src]#</FONT><FONT color=#ffff00> tar -zxvf /root/pwebstats-1.3.8.tar.gz</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 此时会产生 /usr/local/src/pwebstats-1.3.8 这个目录，这目录里面</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 已经是可以执行的资料了，不需要进行任何的编译，所以我们将他直接移动到</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># /usr/local/ 里面去！</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test src]# </FONT><FONT color=#ffff00>mv pwebstats-1.3.8 /usr/local/pwebstats</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test src]# </FONT><FONT color=#ffff00>cd /usr/local/pwebstats</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test pwebstats]# </FONT><FONT color=#ffff00>vi pwebstats</FONT><FONT color=#ff6666> &lt;==这个是主要的执行档！</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 由于我们的 perl 这个程序语言的执行档是放置在 /usr/bin/perl ，但是</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 这支程序预设是书写为：</FONT> <BR><FONT face=SimSun color=#ffff99 size=-1>#!/usr/local/bin/perl</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 将上面改写为</FONT> <BR><FONT face=SimSun color=#ffff99 size=-1>#!/usr/bin/perl</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 这样就可以了！继续下一步！</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>4. 开始设定 squid 的输出输入参数：</FONT> <BR><FONT face=SimSun color=#ffff99 size=-1>前提要件：</FONT> <BR><FONT face=SimSun color=#ffff99 size=-1>a. 我的 WWW 主页目录在 /var/www/html</FONT> <BR><FONT face=SimSun color=#ffff99 size=-1>b. 我的 pwebstats 整个数据库放置在 /usr/local/pwebstats</FONT> <BR><FONT face=SimSun color=#ffff99 size=-1>c. 我的 squid 登录档放置在 /usr/local/squid/var/logs/access.log.0</FONT> <BR><FONT face=SimSun color=#ffff99 size=-1>d. 我的 squid 的执行档为 /usr/local/squid/sbin/squid</FONT> <BR><FONT face=SimSun color=#ffff99 size=-1>e. 我的 pwebstats 输出的数据放置在 /var/www/html/pwebstats&nbsp;</FONT> <BR><FONT face=SimSun color=#ffff99 size=-1>f. 我的 fly 是放在 /usr/local/bin/fly</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test pwebstats]#</FONT><FONT color=#ffff00> mkdir /var/www/html/pwebstats</FONT><FONT color=#ff6666>&lt;=请依您的主机而定</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test pwebstats]# </FONT><FONT color=#ffff00>cd /usr/local/pwebstats/conf</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test conf]#</FONT><FONT color=#ffff00> vi squid-proxy.conf&nbsp;</FONT><FONT color=#ff6666> &lt;==这个就是主要的设定档！</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 底下请填写你的主机的『昵称』！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>server:My_Proxy_Server</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 这个是显示在网页上面的标题内容！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>Server_header:我的代理服务器</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># squid 登录档放置的完整档名</FONT> <BR><B><FONT face=SimSun color=#ffff00 size=-1>logfile:/usr/local/squid/var/logs/access.log.0</FONT></B> <BR><FONT face=SimSun color=#ff6666 size=-1># 我们使用的就是 squid 的登录档啊！所以这里不需改变</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>logtype:squid</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 刚刚提到的，网页数据要输出到底下的目录</FONT> <BR><B><FONT face=SimSun color=#ffff00 size=-1>outdir:/var/www/html/pwebstats</FONT></B> <BR><FONT face=SimSun color=#ff6666 size=-1># 一些图像档案的预设目录，这里我们使用 pwebstats 提供的目录！</FONT> <BR><B><FONT face=SimSun color=#ffff00 size=-1>templates:/usr/local/pwebstats/templates</FONT></B> <BR><FONT face=SimSun color=#ff6666 size=-1># 嗯！我们就天天来进行一次吧！可以用 weekly 或 daily</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>interval:daily</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 是否在执行的过程中给他输出讯息呢？好吧！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>verbose:true</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># fly 放置的目录，刚刚我们移动的目录啊！</FONT> <BR><B><FONT face=SimSun color=#ffff00 size=-1>fly_prog:/usr/local/bin/fly</FONT></B> <BR><FONT face=SimSun color=#ff6666 size=-1># 本机端的要求，这里可以不用设定喔！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>local_patt:</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 列出几部 client 计算机？我给他来个 50 部好了！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>host_threshold:50</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 列出几部 Server (被要求资料者)，还是给个 100 部吧！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>remote_host_threshold:100</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 统计的次数，给他 100 次好了！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>item_threshold:100</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 做多少个 domain 的分析？给他 15 个就够多了！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>domain_threshold:15</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 底下保留默认值即可！ (最后面的 dns 反查可以启动！)</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>exclude_reqs:true</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>#complete_exclude_host:</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>#complete_exclude_url_patt:</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>#complete_exclude_user:</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>dns_lookup:true</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 事实上，只要上面粗体字的地方写对就好了！其它的保留默认值即可！</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>5. 测试执行一次看看：</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test conf]#</FONT><FONT color=#ffff00> /usr/local/squid/sbin/squid -k rotate</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>上面这个动作会将 squid 的登录档进行 logrotate 的动作喔！就会更新了</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>/usr/local/squid/var/logs/access.log.0 这个档案啦！</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test conf]# </FONT><FONT color=#ffff00>/usr/local/pwebstats/pwebstats -c&nbsp; \</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>&gt;</FONT><FONT color=#ffff00> /usr/local/pwebstats/conf/squid-proxy.conf</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>.....(略)......</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>-- Reading in log file /usr/local/squid/var/logs/access.log.0:</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp; The logfile has 27 entries.</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp; Processing...</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp; 0%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 50%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 100%</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp; |-----------------------|------------------------|</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp; ##################################################</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>&nbsp;&nbsp; Finished.</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>.....(略)......</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>呵呵！这样就是成功啦！！！！</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>6. 将每天执行的指令写成 scripts 吧！</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 我将他写在/usr/local/pwebstats/pwebstats.sh 这个档案当中喔！</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test conf]#</FONT><FONT color=#ffff00> vi /usr/local/pwebstats/pwebstats.sh</FONT></FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>#!/bin/bash</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>/usr/local/squid/sbin/squid -k rotate</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>sync; sleep 5s</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>/usr/local/pwebstats/pwebstats -c /usr/local/pwebstats/conf/squid-proxy.conf</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test conf]# </FONT><FONT color=#ffff00>chmod 755 /usr/local/pwebstats/pwebstats.sh</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test conf]#</FONT><FONT color=#ffff00> vi /etc/crontab&nbsp;</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 加入底下这一行吧！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>59 2 * * * root /usr/local/pwebstats/pwebstats.sh &gt;/dev/null 2&gt;&amp;1</FONT></TD></TR></TBODY></TABLE>&nbsp;</OL>很简单吧！这样就安装完毕了！不过，由于我们安装的 fly 可能有点问题啦！就我的系统来说，这个 fly 总是编的怪怪的～如果您的 fly 无法编译成功的话，那么直接由鸟哥的私房菜提供的档案来直些下载使用算了！ <A href="http://linux.vbird.org/download/">http://linux.vbird.org/download</A> 找一下 fly 的 binary ，下载完毕之后，请记得： <BR>　 
<UL><FONT face=SimSun color=#000066>gzip -d fly.gz</FONT> <BR><FONT face=SimSun color=#000066>chmod 755 fly</FONT> <BR><FONT face=SimSun color=#000066>mv fly /usr/local/bin</FONT></UL>　 <BR>这样就可以了！而刚刚我们不是有执行过一次吗？你的登录数据会被放置在 /var/www/html/pwebstats 这个目录当中！假如我的首页就是 /var/www/html/ 的话，那么我的网址列输入 http://myIP/pwebstats 就可以看到类似下图： <BR>　 <BR><IMG height=461 src="71_files/0420squid_pwebstats_1[1].jpg" width=489 border=2 nosave=""> <BR>　 <BR>在按下了『Day 1』之后，会出现如下的画面： <BR>　 <BR><IMG height=491 src="71_files/0420squid_pwebstats_2[1].jpg" width=509 border=2 nosave=""> <BR>　 <BR>呵呵！更详细的内容您就可以自行看看！加油的啦！！ <BR>　 <BR>
<HR width="100%">
<A name=serverahead_sarg></A><FONT color=#000099 size=+1>末端资料分析 sarg</FONT> <BR>　 <BR>除了上面介绍的 pwebstats 之外，其实还有一套相当棒而且功能相当强悍的分析软件，那就是 <A href="http://web.onda.com.br/orso/sarg.html" target=_blank>Squid Analysis Report Generator</A> ( Squid 分析报告制作者)，他的官方网站在：<A href="http://web.onda.com.br/orso/sarg.html" target=_blank>http://web.onda.com.br/orso/sarg.html</A>，他的原理相当的简单，就是将 logfile 拿出来，然后进行一下解析，依据不同的时间、网站、与热门网站等等来进行数据的输出，由于输出的结果实在是太详细了！所以.....呵呵！如果你是老板的话，用这个软件会让你『爱不释手』啊！因为每个人的每个小动作都会被记录下来，我的天龋〉蔽业谝淮慰吹秸飧龇治龅幕面时，真的给他吓了老大一跳得说～因为连每个 IP 在『每个小时所连上的每个网站数据』都有纪录～～害怕了吧～ <BR>　 <BR>不过，有优点就有缺点啦！怎么说呢？因为 SARG 功能太强大了，所以记录的『数据量』就实在是多了点，如果您的 Proxy 网站属于那种很大流量的网站时，那么就不要使用『日报表』，也就是每天产生一份报表的那种方式！那么由于数据一天可能会有几 MB 的数据，一两个月还没有关系，如果记录了几年，那么光是这些记录就会花掉好几 GB 的硬盘空间了～此外，也可以使用『覆盖旧有数据』的方式不要留存旧数据，这样也可以节省硬盘的空间啦！ <BR>　 <BR>这个 SARG 软件已经出到 1.4 版，更好的是，他支援『多国语系』呢！目前鸟哥已经翻译了一部分的资料，希望能对大家有点帮助啊！对于这个套件，你可以到官方网站上下载最新的版本 ( <A href="http://web.onda.com.br/orso/sarg.html" target=_blank>http://web.onda.com.br/orso/sarg.html</A> ) ，而鸟哥这里也有提供啦！我提供的版本是 1.4 的( 在 2003/03/16 释出的版本 )，已经经过了 patch (套件修补) 的动作，并且加入中文化的语言档案，所以直接下载就有中文显示！请到档案下载中心下载： <BR>　 
<UL>
<LI><A href="http://linux.vbird.org/download#squid_ap">http://linux.vbird.org/download#squid_ap</A> </LI></UL>　 <BR>整个安装与执行的过程很简单的！我们来试看看吧！(注：假设您已经将 sarg-1.4.taiwan_big5.tar.gz 放置在 /root 底下了！)： <BR>　 
<TABLE cols=1 width=549 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun color=#ffffcc size=-1># 1. 解压缩：</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]#</FONT><FONT color=#ffff00> cd /usr/local/src</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test src]# </FONT><FONT color=#ffff00>tar -zxvf /root/sarg-1.4.taiwan_big5.tar.gz</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>....(略).....</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>这个时候会产生一个名为 sarg-1.4 的目录出来！</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 2. 设定、编译与安装</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test src]# </FONT><FONT color=#ffff00>cd sarg-1.4</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test sarg-1.4]# </FONT><FONT color=#ffff00>mkdir /usr/local/sarg</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test sarg-1.4]# </FONT><FONT color=#ffff00>./configure --prefix=/usr/local/sarg&nbsp; \</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>&gt;</FONT><FONT color=#ffff00> --enable-mandir=/usr/local/sarg/man1&nbsp; \</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>&gt;</FONT><FONT color=#ffff00> --enable-bindir=/usr/local/sarg/bin&nbsp; \</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>&gt;</FONT><FONT color=#ffff00> &amp;&amp; make &amp;&amp; make install</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>这样可以快速的设定、编译与安装，一次完成！</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>安装的数据当中：</FONT> <BR><FONT face=SimSun color=#ffff99 size=-1>a. 设定档 /usr/local/sarg/sarg.conf</FONT> <BR><FONT face=SimSun color=#ffff99 size=-1>b. 执行档 /usr/local/sarg/bin/sarg</FONT> <BR><FONT face=SimSun color=#ffff99 size=-1>c. 说明档 /usr/local/sarg/man1/sarg.1</FONT> <BR><FONT face=SimSun color=#ffffff size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 3. 额外设定 ( 说明文件的路径 )</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]#</FONT><FONT color=#ffff00> vi /etc/man.config </FONT><FONT color=#ff6666>(有时为 man.conf n名不同！)</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>新增加这一行</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>MANPATH /usr/local/sarg</FONT></TD></TR></TBODY></TABLE>　 <BR>相信吗？这样就安装完毕了！很快速吧！接下来你要做的就是设定！设定之前请先注意您的相关数据，以我为例，我的相关资料为： <BR>　 
<UL>
<LI><FONT color=#000066>登录档使用 /usr/local/squid/var/logs/access.log.0 这一个经过 rotation 的档案；</FONT> 
<LI><FONT color=#000066>计算的暂存档放置在 /tmp 底下；</FONT> 
<LI><FONT color=#000066>我的 SARG 输出的首页放置在 /var/www/html/sarg 这个『目录』之中；</FONT> 
<LI><FONT color=#000066>我想要让我的网页以 big5 的字符编码格式输出！</FONT> </LI></UL>　 <BR>这个时候我只要修改一个档案，也就是 /usr/local/sarg/sarg.conf 即可，内容有点像这样： <BR>　 
<TABLE cols=1 width=549 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]# </FONT><FONT color=#ffff00>mkdir /var/www/html/sarg</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]#</FONT><FONT color=#ffff00> vi /usr/local/sarg/sarg.conf</FONT></FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 这个档案是 sarg 的设定档，里面已经将整个设定参数讲的很清楚了，</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 你可以依照你的情况来调整这个档案的参数，无论如何，这个档案里面</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 应该至少要有底下这几个数据，其它的请自行使用喔！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>language Taiwan_big5</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>access_log /usr/local/squid/var/logs/access.log.0</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>title "Squid 使用状态报告"</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>temporary_dir /tmp</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>output_dir /var/www/html/sarg</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>overwrite_report no</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>mail_utility /bin/mail</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>topsites_num 100</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>exclude_codes /usr/local/sarg/exclude_codes</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>max_elapsed 28800000</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>charset big5</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>　</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]#</FONT><FONT color=#ffff00> /usr/local/sarg/bin/sarg</FONT></FONT> <BR><FONT face=SimSun color=#ffffff size=-1>SARG: 制作报告完成于 /var/www/html/sarg/2003Apr10-2003Apr11</FONT></TD></TR></TBODY></TABLE>　 <BR>试跑一下，嘿嘿！已经成功的输出数据！这个时候，请在您的浏览器上面输入 http://your.domain.or.IP/sarg 即可看到刚刚跑出来的资料了！很棒吧！好了，我总不能常常这样手动的跑分析数据吧？OK！那么怎么将这个动作放到 crontab 当中呢？！呵呵！我们底下写了一支 script 来同时跑 pwebstats 及 SARG 这两个玩意儿～这支 script 是长这样的： <BR>　 
<TABLE cols=1 width=549 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun color=#ffffcc size=-1>1. 建立这支程序：我将他取名为 /usr/local/squid/etc/squid.logrotate</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]# </FONT><FONT color=#ffff00>vi /usr/local/squid/etc/squid.logrotate</FONT></FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>#!/bin/bash</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1># 这支程序是要写来做为 squid 的 log files analysis 之用的！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1># 执行的方法为 crontab ！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1># vi /etc/crontab 加入底下这一行：</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1># 59 23 * * * root /usr/local/squid/etc/squid.logrotate</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>　</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1># 1. parameters settings</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>PATH=/sbin:/bin:/usr/sbin:/usr/bin</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>　</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1># 2. stoping and rotating squid</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>sleep 50s</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>/usr/local/squid/sbin/squid -k rotate</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>/usr/local/squid/sbin/squid -k shutdown</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>　</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1># 3. pwebstats processing</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>/var/www/html/pwebstats/pwebstats -c&nbsp; \</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /var/www/html/pwebstats/conf/squid-proxy.conf \</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt; /dev/null 2&gt;&amp;1</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>　</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1># 4. sarg processing</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>/usr/local/sarg/bin/sarg &gt; /dev/null 2&gt;&amp;1</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>　</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1># 5. starting squid</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>sleep 11s</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>su nobody -c "/usr/local/squid/bin/RunCache &amp;" &gt; /dev/null 2&gt;&amp;1</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1>　</FONT> <BR><FONT face=SimSun color=#ffffcc size=-1># 2. 改变档案权限与加入 crontab 排程当中！</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]#</FONT><FONT color=#ffff00> chmod 744 /usr/local/squid/etc/squid.logrotate</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]# </FONT><FONT color=#ffff00>vi /etc/crontab</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1>加入这一行：</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>59 23 * * * root /usr/local/squid/etc/squid.logrotate</FONT></TD></TR></TBODY></TABLE>　 <BR>这一支程序有什么特点呢？由于我是在 23:59 开始执行，而且执行时期先等待 (sleep) 50 秒钟，且工作完毕后再等 10 秒钟，也就是说，我的 squid 的 log 档案一定会是以天为单位来分隔，所以我们所看到的数据就会『一」天一天』的显示，而不会跨了不同的两天了！我是比较喜欢这样啦！但是每个人的观点不同，您可以自由调配喔！ <BR>　 <BR>
<HR width="100%">
<A name=serverahead_firewall></A><FONT color=#000099 size=+1>防火墙的规划</FONT> <BR>　 <BR>事实上， Proxy 本身就已经可以做为一个防火墙啦！为何还需要针对 Proxy 来进行防火墙的规划？话是这样没错啦！但是我们的 Proxy 是开放 3128 与 3130 这两个 port 啊！您总不能这两个 port 没有开放吧！所以，要让您的 Proxy 可以对外面开始服务，就需要启用 3128 这个标准的 Proxy port ！所以需要在您的防火墙 scripts 当中加入这一行： <BR>　 
<UL><FONT face=SimSun color=#000066 size=-1>/sbin/iptables -A INPUT -p TCP -i eth0&nbsp; --dport 3128:3130 -j ACCEPT</FONT></UL>　 <BR>一般来说，这样就可以正常的启动 Proxy 的服务了！那么至于 Proxy 本身提供的防火墙内容呢？呵呵！就利用 acl 配合 http_access 就能够管制使用者的使用空间了！真是相当的具有弹性啊！ ^_^ <BR>　 <BR>
<HR width="100%">
<A name=serverahead_transparent></A><FONT color=#000099 size=+1>NAT 与 Proxy 透过 transparent proxy 设定加快网络传输</FONT> <BR>　 <BR>让我们现在来想象一个联机状态，就是你有一整组内部网络，而这个内部网络都是透过 NAT 主机联机出去的。那么我们谈过，就是在一个内部网域很大的情况下，使用 Proxy 是一个很不错的选择，因为至少他可以减轻频宽的负荷啊！OK！那么我们就架设 Proxy 好了，不过，遗憾的是，架设 Proxy 的时候，也要使用者在浏览器上面设定了你架设好的浏览器才有用啊！否则那部 Proxy 没有人使用的话，架了也是白搭！好了，那么有没有办法在『<FONT color=#000066>使用者不需要在浏览器上面进行任何设定，就可以实现以 Proxy 帮助使用者捉取 WWW 数据 』</FONT>呢？当然有啦！那就是 Transparent Proxy 啦！也有人翻译成『通透式代理服务器』，为什么这么翻译我也不晓得？？不过，他的原理是这样的： <BR>　 
<UL>
<LI><FONT color=#000066>当使用者经过 NAT 服务器来联机进入 Internet 时，假如使用的 Internet 协议为 80 (也就是 WWW) ，那么就将这个要求交给 Proxy 来工作，以达到代理服务器的功能。</FONT> </LI></UL>　 <BR>呵呵！也就是说，当使用者是经过 NAT 主机联机出去时，只要让 NAT 主机发现『咦！你是要去捉 WWW 的资料对吧！好！那么这个动作由 Proxy 主机帮你搞定！』如此一来，使用者根本就不需要在浏览器上面设定 Proxy 的相关数据，因为这个动作是『由 NAT 主机自己决定的』，所以只要在 NAT 主机上面设定妥当即可，使用者不必设定任何数据呢！呵呵！真是不错！那么要怎么进行呢？只要两个步骤即可： <BR>　 
<OL>
<LI><B><FONT color=#000099>设定 Proxy 主机：</FONT></B> <BR>设定 proxy 主机当然就是要又修改 squid.conf ！而这个设定相当的简单喔！只要几行就可以搞定： <BR>　 
<TABLE cols=1 width=549 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]#</FONT><FONT color=#ffff00> vi /usr/local/squid/etc/squid.conf</FONT></FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 这里请填入你的 Proxy 主机名称 与 port ！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>httpd_accel_host vbird.adsldns.org</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 因为我们是要进行 WWW 的数据快取，所以 port 当然就是 80 ！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>httpd_accel_port 80</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 这个很重要！因为设定 httpd_accel_host 之后， cache 的设定会自动被终止，</FONT> <BR><FONT face=SimSun color=#ff6666 size=-1># 必须要加上这个设定为 on 之后，才能提供 cache 的功能！</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>httpd_access_with_proxy on</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>httpd_accel_uses_host_header on</FONT> 
<P><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]#</FONT><FONT color=#ffff00> /usr/local/squid/sbin/squid -k reconfigure</FONT></FONT></P></TD></TR></TBODY></TABLE>　 <BR>总共就是这四行啦！这样就设定好一个 squid 的 transparent proxy 的功能！ <BR>　 
<LI><B><FONT color=#000099>设定 NAT 主机的 port map ：</FONT></B> <BR>再来让我们到 NAT 主机上面看看先，因为需要将 80 这个 port 交给 Proxy 的 3128 来帮忙协助，所以你的防火墙 script 必须要加入这一段才行： <BR>　 
<TABLE cols=1 width=549 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun color=#ffff00 size=-1>iptables -t nat -A PREROUTING -i eth0 -p tcp -s 192.168.0.0/24 \</FONT> <BR><FONT face=SimSun color=#ffff00 size=-1>--dport 80 -j REDIRECT --to-ports 3128</FONT></TD></TR></TBODY></TABLE>　 <BR>注意一下，那个 eth0 是『你的 NAT 对内的网络卡装置代号』，至于 192.168.0.0/24 则是你的内部网域，请依照你的主机实际状态来设定喔！ <BR>&nbsp;</LI></OL>完全不需要怀疑！这样一来，您的 client 端完全不需要进行任何的设定，立刻就可以使用 Proxy 的好处！很不错吧！呵呵！ <BR>　 <BR>
<HR width="100%">
<A name=serverahead_beca></A><FONT color=#000099 size=+1><FONT face="Times New Roman Baltic">squid </FONT>的注意事项</FONT> <BR>　 <BR>使用代理服务器后，浏览国外的网页应该是可以变快的！但是，你要小心几件事： <BR>　 
<OL>
<LI><FONT color=#000066>若 squid 内设定的使用空间满了，则 squid 将不会运作！</FONT> 
<LI><FONT color=#000066>若 squid 的纪录文件太大了，则工作效率会变慢！</FONT> </LI></OL>　 <BR>由于我们已经安装的 pwebstats 了，并且已经设定好了 squid -k rotate 的工作，所以第二个问题并不严重，严重的可能会是第一个问题！所以有可能我们会自行手动的删除 Proxy 的快取目录，如何删除呢？虽然上面已经提过了一些注意事项，这里我们再次的说明吧！ <BR>　 
<TABLE cols=1 width=549 bgColor=#000000 border=1>
<TBODY>
<TR>
<TD><FONT face=SimSun color=#ffffff size=-1>1. 停止 squid&nbsp;</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]# </FONT><FONT color=#ffff00>kill -9 `cat /usr/local/squid/var/logs/squid.pid`</FONT></FONT> <BR><FONT face=SimSun color=#ffffff size=-1>(可能会重复做 5 次左右才会完全砍掉！)</FONT> 
<P><FONT face=SimSun color=#ffffff size=-1>2. 删除暂存目录 (这个目录请依您的系统而定！)</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]# </FONT><FONT color=#ffff00>rm -rf /usr/local/squid/var/cache1</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]# </FONT><FONT color=#ffff00>mkdir /usr/local/squid/var/cache1</FONT></FONT> </P>
<P><FONT face=SimSun color=#ffffff size=-1>3. 重建快取目录并重新启动</FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]# </FONT><FONT color=#ffff00>/usr/local/squid/sbin/squid -z</FONT></FONT> <BR><FONT face=SimSun size=-1><FONT color=#ffffff>[root@test root]# </FONT><FONT color=#ffff00>su nobody -c "/usr/local/squid/bin/RunCache &amp;"</FONT></FONT></P></TD></TR></TBODY></TABLE>　 <BR>其它的建议： 
<OL>　 
<LI><FONT color=#000066>关于上层代理服务器</FONT>：用 cache_peer 设定上层代理服务器的数目不要太多，只要 2-5 个之间就好了，而且上层代理服务器一定要找距离你最近，并且具有较大频宽的主机，如果是在台南，那 proxy.ncku.edu.tw 就是不错的主机，或者向您的 ISP 询问喔； <BR>　 
<LI><FONT color=#000066>关于暂存目录的设定</FONT>：以 cache_dir ufs 设定的目录，最好是单独割出来的约 1-2 GB 的硬盘槽，以我为例，我将另外一台主机的 30GB 的硬盘割两槽给 proxy 用，而每一槽只有 2GB ，分别命名为 proxy1 与 proxy2 ，则可以写成 
<OL><FONT face=SimSun color=#000066>　</FONT> <BR><FONT face=SimSun color=#000066>cache_dir ufs /proxy1 2000 16 256</FONT> <BR><FONT face=SimSun color=#000066>cache_dir ufs /proxy2 2000 16 256</FONT> <BR><FONT face=SimSun color=#000066>　</FONT></OL>由于分成两槽来存取，所以整体效率上会比较好，但这是针对一般比较大型的代理服务器的设定了，我们这个小主机就不用如此设定(但是效率真的有差哩！)。 <BR>　 
<LI><FONT color=#000066>善用 acl, always_direct, never_direct</FONT>：就如同上面提到的，因为你的目的不同，所以会使用到不同的 proxy 作为你的上层代理服务器，如果你发现你的上层代理服务器无法针对你常上的网站来求取资料时，就将那个网站加入你的 always_direct 吧！另外，也可以使用 cache_peer_access 来处理喔！ <BR>　 
<LI><FONT color=#000066>在 ./configure 的时候增加 --enable-async-io=80 这一个指令</FONT>：基本上，增加这个指令之后，将可以使您的磁盘多一个 type ，亦即是 aufs ，这个 type 的速度较快！ </LI></OL></UL>
<HR width="100%">
<A name=important></A><FONT color=#000099 size=+1>重点回顾</FONT> 
<UL>
<LI><FONT color=#000066>代理服务器 ( Proxy ) 最大的功能是在代理使用者向 Internet 要求 Web page 的数据，同时达成 Web pages 的快取记录 (Cache) ，以达到假性的频宽节省目的；此外，还可以额外的达成防火墙的功能；</FONT> 
<LI><FONT color=#000066>目前 Unix Like 的机器中，做为 proxy 功能的服务器软件几乎都是使用 squid ，而 squid 仅需要设定 squid.conf 这个设定档即可使用；</FONT> 
<LI><FONT color=#000066>设定 Proxy 时，如果能以频宽更大的上层 Proxy 来帮助，将有助于 Client 端浏览速度的提升；</FONT> 
<LI><FONT color=#000066>以防火墙的功能来说， Proxy 使用应用层的方式来达成防火墙功能，至于 iptables 则是更为底层的 TCP/IP 分析的方式；</FONT> 
<LI><FONT color=#000066>Proxy 对于硬件的要求较高，尤其是硬盘的 partition 与内存，一般来说，一个 cache 目录最好就是一个 partition ，而一个 cache partition 最好容量在 2-4 GB 之间即可；</FONT> 
<LI><FONT color=#000066>transparent proxy 的功能就是可以让 client 端不需要设定浏览器的 proxy 功能，即可进行 proxy 的工作；</FONT> </LI></UL>
<HR width="100%">
<A name=reference></A><FONT color=#000099 size=+1>参考资源</FONT> 
<UL>
<LI>优客笔记本：<A href="http://turtle.ee.ncku.edu.tw/~tung/proxy/" target=_blank>http://turtle.ee.ncku.edu.tw/~tung/proxy/</A> 
<LI>台北市教育网络中心：<A href="http://www.tp.edu.tw/document/squid/index.files/frame.htm" target=_blank>http://www.tp.edu.tw/document/squid/index.files/frame.htm</A> 
<LI>squid 官方网站：<A href="http://www.squid-cache.org/" target=_blank>http://www.squid-cache.org/</A> 
<LI>squid 说明文件计划：<A href="http://squid-docs.sourceforge.net/" target=_blank>http://squid-docs.sourceforge.net/</A> 
<LI>中山大学资讯工程所：<A href="http://www.cc.nsysu.edu.tw/~lmj/Squid.files/frame.htm" target=_blank>http://www.cc.nsysu.edu.tw/~lmj/Squid.files/frame.htm</A> 
<LI>鹭江国小：<A href="http://proxy.lcps.tpc.edu.tw/" target=_blank>http://proxy.lcps.tpc.edu.tw/</A> 
<LI>fly 官方网站：<A href="http://martin.gleeson.com/fly/index.html" target=_blank>http://martin.gleeson.com/fly/index.html</A> 
<LI>pwebstats 官方网站：<A href="http://martin.gleeson.com/pwebstats/index.html" target=_blank>http://martin.gleeson.com/pwebstats/index.html</A> </LI></UL>
<HR width="100%">
<A name=FAQ></A><FONT color=#000099 size=+1>本章习题练习 ( 要看答案请将鼠标移动到『答：』底下的空白处，按下左键圈选空白处即可察看 )</FONT> 
<UL>
<LI>请说明为何 Proxy 可以提升网络的 WWW 浏览速度？ 
<LI>万一 squid 发生了问题，请问我该如何找出问题点？ 
<LI>请说明 Proxy 服务器的功能为何？ 
<LI>试说明为何 Proxy 服务器可以提升网域之内的网络安全性？ <BR><A href="http://linux.vbird.org/linux_server/1000results.php#0420squid">前往参考用解答</A></LI></UL>
<CENTER><FONT color=#3333ff size=+1><A href="http://linux.vbird.org/linux_server/0420squid.php"><FONT face=SimSun>简易</FONT> Proxy Server <FONT face=SimSun>架设</FONT></A></FONT></CENTER>
<HR width="100%">
<FONT face=SimSun color=#000066 size=-1>2001/??/??：第一次完成日期，其实已经忘记了～</FONT> <BR><FONT face=SimSun color=#000066 size=-1>2001/11/09：加入增加 Proxy 效能的方法，就是使用多颗硬盘做成的数据储存方式！</FONT> <BR><FONT face=SimSun color=#000066 size=-1>2003/04/04：完成大幅度的改写动作！加入了完整的 Proxy 说明，与 pwebstats 的架设！</FONT> <BR><FONT face=SimSun color=#000066 size=-1>2003/04/11：完成了另一个末端分析的强大软件 <A href="#serverahead_sarg">SARG 分析套件</A>！</FONT> <BR><FONT face=SimSun color=#000066 size=-1>2003/09/16：微幅调校一下版面！</FONT> <BR>
<HR width="100%">
<FONT face=SimSun color=#3333ff size=-1>2002/ 01/01以来统计人数</FONT> <BR><IMG height=15 src="71_files/Count[9].gif" width=60 align=middle nosave="">
<HR width="100%">
 
<CENTER><A href="http://linux.vbird.org/" target=_top><IMG height=25 src="61_files/VBirdTitle2[10].jpg" width=90 border=0 nosave=""></A> <A href="http://linux.vbird.org/linux_basic"><IMG height=25 src="39_files/icon_system[3].gif" width=90 border=0 nosave=""></A> <A href="http://linux.vbird.org/linux_server"><IMG height=25 src="55_files/icon_server[13].gif" width=90 border=0 nosave=""></A> <A href="http://linux.vbird.org/linux_security"><IMG height=25 src="71_files/icon_security[10].jpg" width=90 border=0 nosave=""></A> <A href="http://phorum.vbird.org/" target=_blank><IMG height=25 src="60_files/icon_forums[10].gif" width=90 border=0 nosave=""></A> <A href="http://linux.vbird.org/adsl"><IMG height=25 src="50_files/icon_adsl[13].gif" width=90 border=0 nosave=""></A> <BR><FONT color=#000066 size=-1>Designed by <A href="mailto:vbird@tsai.adsldns.org">VBird</A> during 2001-2004.&nbsp; Aerosol Lab.</FONT></CENTER></BODY>